import{f as ze,s as re,n as ne,r as Xe,o as Ye,b as Ce,j as Ne,c as Ke,i as Ie}from"./scheduler.da9d0849.js";import{S as oe,i as le,s as N,g as v,c as I,h,j as S,f as d,k as p,l as W,F as C,a as q,A as a,C as ke,m as H,z as se,n as J,o as Q,G as Pe,r as he,u as be,v as me,d as _e,t as ye,w as Se}from"./index.5d2acbf4.js";import{w as Ae}from"./index.b9f67257.js";import{s as Z,u as We}from"./statusStore.cf99fd43.js";const He=t=>{let s,e=!1;return{isConnected:()=>e,connect:async()=>{var m;if(s=await navigator.bluetooth.requestDevice({filters:[{namePrefix:"nrf52"}],optionalServices:t.map(g=>g.serviceId)}),!s.gatt)throw new Error("No GATT server");const u=await((m=s.gatt)==null?void 0:m.connect());if(!u)throw new Error("No connect to GATT server");return await t.forEach(async g=>await g.addServiceTo(u)),e=!0,s.addEventListener("gattserverdisconnected",g=>{console.error("disconnected BLE",g),e=!1}),!0},disconnect:async()=>{var u;await((u=s==null?void 0:s.gatt)==null?void 0:u.disconnect())},bleDevice:s}},Le=t=>{const{name:s,serviceId:e,characteristicId:r,readParser:l,setParser:i}=t;let n,u;const m=async y=>{if(u=y,!u.connected)throw new Error("BLE Server not connected");return n=await(await u.getPrimaryService(e)).getCharacteristic(r),t.isNotifiable&&(await n.startNotifications(),n.addEventListener("characteristicvaluechanged",f=>{const b=f.target;if(!l)throw new Error("readParser not defined");b.value&&_(l(b.value))})),!0};async function g(){if(!l)throw new Error("readParser not defined");return u!=null&&u.connected?await l(await n.readValue()):(console.warn("setVal, no connection",{name:s}),l(new DataView(new ArrayBuffer(0))))}async function T(y){await n.writeValue(y)}async function w(y){if(!i)throw new Error("setParser not defined");if(!(u!=null&&u.connected))return console.error(`${s} setVal, no connection`);const c=i(y);console.log("setVal",{value:y,parsedValue:c}),await n.writeValue(c)}let _=y=>{console.warn("onNotification not implemented:",{name:s,value:y})};return{addServiceTo:m,serviceId:e,getVal:g,setVal:w,setValRaw:T,onNotification:y=>{if(!t.isNotifiable)throw new Error(`${s} Characteristic is not set as notifiable`);_=y}}},Ge=Le({name:"Battery",serviceId:"battery_service",characteristicId:"battery_level",isNotifiable:!0,readParser:t=>t.getUint8(0).toString()}),Me=Le({name:"Leds",serviceId:"a3941db0-a97c-4cf1-943f-a25ff9ba40cd",characteristicId:"5b8c0ab6-a058-4684-b2b6-4a0a692e2d45",isNotifiable:!1,readParser:t=>(console.log("dataView leds",t),t.getInt8(0)+""+t.getInt8(1)),setParser:t=>{if(typeof t=="string"){const[s,e]=t.split("").map(r=>parseInt(r));return new Uint8Array([s,e])}else return console.log("unhandled data setParser",t),new Uint8Array([0,0])}}),Je=He([Me,Ge]),Qe={...Je,leds:Me,battery:Ge},$e="stear",we=Ae({key:$e,lm:0,rm:0}),Ze=t=>!!(typeof t=="object"&&t&&"key"in t&&t.key===$e),qe=t=>{we.update(s=>({...s,...t}))},gt=t=>{console.log("bindStearingStoreToConnDownStream"),t.on("data",s=>{Ze(s)&&qe(s)})},pt=t=>{console.log("bindStearingStoreToConnDownStream"),we.subscribe(e=>{t.send(e)});const s=ze(we);t.send(s)},je="btn",ae=Ae({key:je,horn:!1,lights:!1,speedMode:!1});let Ve;const Fe=t=>{clearTimeout(Ve),Ve=setTimeout(()=>{t()},100)},Re=t=>{ae.update(s=>({...s,...t}))},xe=t=>!!(typeof t=="object"&&t&&"key"in t&&t.key===je),vt=t=>{console.log("bindStatusStoreToConnDownStream"),t.on("data",s=>{xe(s)&&Re(s)})},ht=t=>{console.log("bindStatusStoreToConnUpStream"),ae.subscribe(s=>{Fe(()=>{t.send(s)})})},ve=(t,s)=>{console.log("btnPress!"),Fe(()=>{ae.update(e=>({...e,[t]:!e[t]})),s||setTimeout(()=>{ae.update(e=>({...e,[t]:!1}))},100)})};function De(t){let s,e="Gamepad connected",r,l,i,n,u,m,g=t[3].rx+"",T,w,_,B;return{c(){s=v("span"),s.textContent=e,r=N(),l=v("div"),i=v("div"),n=H(t[0]),u=N(),m=v("div"),T=H(g),w=N(),_=v("div"),B=H(t[1]),this.h()},l(y){s=h(y,"SPAN",{"data-svelte-h":!0}),se(s)!=="svelte-vjytum"&&(s.textContent=e),r=I(y),l=h(y,"DIV",{class:!0});var c=S(l);i=h(c,"DIV",{class:!0});var f=S(i);n=J(f,t[0]),f.forEach(d),u=I(c),m=h(c,"DIV",{class:!0});var b=S(m);T=J(b,g),b.forEach(d),w=I(c),_=h(c,"DIV",{class:!0});var k=S(_);B=J(k,t[1]),k.forEach(d),c.forEach(d),this.h()},h(){p(i,"class","svelte-1gg25p3"),p(m,"class","svelte-1gg25p3"),p(_,"class","svelte-1gg25p3"),p(l,"class","vals svelte-1gg25p3")},m(y,c){q(y,s,c),q(y,r,c),q(y,l,c),a(l,i),a(i,n),a(l,u),a(l,m),a(m,T),a(l,w),a(l,_),a(_,B)},p(y,c){c&1&&Q(n,y[0]),c&8&&g!==(g=y[3].rx+"")&&Q(T,g),c&2&&Q(B,y[1])},d(y){y&&(d(s),d(r),d(l))}}}function et(t){let s,e,r,l,i,n,u,m,g,T,w,_,B,y,c,f,b,k,P,D,U,V,O,G,L,$,M,ce,j,ie,F,ue,z,fe,X,de,Y,R,ge,K,x,pe,Ee,A=t[4]&&De(t);return{c(){A&&A.c(),s=N(),e=v("section"),r=v("div"),l=N(),i=v("div"),n=v("div"),u=N(),m=v("div"),g=v("div"),T=N(),w=v("button"),_=N(),B=v("button"),y=N(),c=v("button"),f=N(),b=v("button"),k=N(),P=v("button"),D=N(),U=v("button"),V=N(),O=v("button"),G=N(),L=v("button"),$=N(),M=v("button"),ce=N(),j=v("button"),ie=N(),F=v("button"),ue=N(),z=v("button"),fe=N(),X=v("button"),de=N(),Y=v("button"),ge=N(),K=v("button"),this.h()},l(E){A&&A.l(E),s=I(E),e=h(E,"SECTION",{class:!0});var o=S(e);r=h(o,"DIV",{class:!0}),S(r).forEach(d),l=I(o),i=h(o,"DIV",{class:!0});var Te=S(i);n=h(Te,"DIV",{class:!0,style:!0}),S(n).forEach(d),Te.forEach(d),u=I(o),m=h(o,"DIV",{class:!0});var Be=S(m);g=h(Be,"DIV",{class:!0,style:!0}),S(g).forEach(d),Be.forEach(d),T=I(o),w=h(o,"BUTTON",{class:!0}),S(w).forEach(d),_=I(o),B=h(o,"BUTTON",{class:!0}),S(B).forEach(d),y=I(o),c=h(o,"BUTTON",{class:!0}),S(c).forEach(d),f=I(o),b=h(o,"BUTTON",{class:!0}),S(b).forEach(d),k=I(o),P=h(o,"BUTTON",{class:!0}),S(P).forEach(d),D=I(o),U=h(o,"BUTTON",{class:!0}),S(U).forEach(d),V=I(o),O=h(o,"BUTTON",{class:!0}),S(O).forEach(d),G=I(o),L=h(o,"BUTTON",{class:!0}),S(L).forEach(d),$=I(o),M=h(o,"BUTTON",{class:!0}),S(M).forEach(d),ce=I(o),j=h(o,"BUTTON",{class:!0}),S(j).forEach(d),ie=I(o),F=h(o,"BUTTON",{class:!0}),S(F).forEach(d),ue=I(o),z=h(o,"BUTTON",{class:!0}),S(z).forEach(d),fe=I(o),X=h(o,"BUTTON",{class:!0}),S(X).forEach(d),de=I(o),Y=h(o,"BUTTON",{class:!0,style:!0}),S(Y).forEach(d),ge=I(o),K=h(o,"BUTTON",{class:!0,style:!0}),S(K).forEach(d),o.forEach(d),this.h()},h(){p(r,"class","pad svelte-1gg25p3"),p(n,"class","stick svelte-1gg25p3"),W(n,"transform",t[7]()),C(n,"click",t[2].lstick),p(i,"class","well left svelte-1gg25p3"),p(g,"class","stick svelte-1gg25p3"),W(g,"transform",t[6]()),C(g,"click",t[2].rstick),p(m,"class","well right svelte-1gg25p3"),p(w,"class","button a svelte-1gg25p3"),C(w,"on",t[2].a),p(B,"class","button b svelte-1gg25p3"),C(B,"on",t[2].b),p(c,"class","button x svelte-1gg25p3"),C(c,"on",t[2].x),p(b,"class","button y svelte-1gg25p3"),C(b,"on",t[2].y),p(P,"class","button map svelte-1gg25p3"),C(P,"on",t[2].map),p(U,"class","button menu svelte-1gg25p3"),C(U,"on",t[2].menu),p(O,"class","button xbox svelte-1gg25p3"),C(O,"on",t[2].xbox),p(L,"class","dpad du svelte-1gg25p3"),C(L,"on",t[2].du),p(M,"class","dpad dr svelte-1gg25p3"),C(M,"on",t[2].dr),p(j,"class","dpad dd svelte-1gg25p3"),C(j,"on",t[2].dd),p(F,"class","dpad dl svelte-1gg25p3"),C(F,"on",t[2].dl),p(z,"class","bumper left svelte-1gg25p3"),C(z,"on",t[2].lb),p(X,"class","bumper right svelte-1gg25p3"),C(X,"on",t[2].rb),p(Y,"class","trigger left svelte-1gg25p3"),p(Y,"style",R=t[5]("lt")),p(K,"class","trigger right svelte-1gg25p3"),p(K,"style",x=t[5]("rt")),p(e,"class","controller svelte-1gg25p3"),C(e,"connected",t[4])},m(E,o){A&&A.m(E,o),q(E,s,o),q(E,e,o),a(e,r),a(e,l),a(e,i),a(i,n),a(e,u),a(e,m),a(m,g),a(e,T),a(e,w),a(e,_),a(e,B),a(e,y),a(e,c),a(e,f),a(e,b),a(e,k),a(e,P),a(e,D),a(e,U),a(e,V),a(e,O),a(e,G),a(e,L),a(e,$),a(e,M),a(e,ce),a(e,j),a(e,ie),a(e,F),a(e,ue),a(e,z),a(e,fe),a(e,X),a(e,de),a(e,Y),a(e,ge),a(e,K),pe||(Ee=[ke(window,"gamepadconnected",t[8]),ke(window,"gamepaddisconnected",t[9])],pe=!0)},p(E,[o]){E[4]?A?A.p(E,o):(A=De(E),A.c(),A.m(s.parentNode,s)):A&&(A.d(1),A=null),o&128&&W(n,"transform",E[7]()),o&4&&C(n,"click",E[2].lstick),o&64&&W(g,"transform",E[6]()),o&4&&C(g,"click",E[2].rstick),o&4&&C(w,"on",E[2].a),o&4&&C(B,"on",E[2].b),o&4&&C(c,"on",E[2].x),o&4&&C(b,"on",E[2].y),o&4&&C(P,"on",E[2].map),o&4&&C(U,"on",E[2].menu),o&4&&C(O,"on",E[2].xbox),o&4&&C(L,"on",E[2].du),o&4&&C(M,"on",E[2].dr),o&4&&C(j,"on",E[2].dd),o&4&&C(F,"on",E[2].dl),o&4&&C(z,"on",E[2].lb),o&4&&C(X,"on",E[2].rb),o&32&&R!==(R=E[5]("lt"))&&p(Y,"style",R),o&32&&x!==(x=E[5]("rt"))&&p(K,"style",x),o&16&&C(e,"connected",E[4])},i:ne,o:ne,d(E){E&&(d(s),d(e)),A&&A.d(E),pe=!1,Xe(Ee)}}}const Ue=254;function tt(t,s,e){let r,l,i,n=0,u=!1,{ls:m=0}=s,{rs:g=0}=s;const T={y:()=>{ve("horn",!1)},x:()=>{ve("lights",!0)},lt:()=>{ve("speedMode",!0)}},w={a:0,b:0,x:0,y:0,lb:0,rb:0,lt:0,rt:0,map:0,menu:0,lstick:0,rstick:0,du:0,dd:0,dl:0,dr:0,xbox:0},_={lx:0,ly:0,rx:0,ry:0},B=()=>{c(),e(4,u=!0),console.log("GamePad connected")},y=()=>{cancelAnimationFrame(n),e(4,u=!1),console.log("GamePad lost connection")},c=()=>{const f=navigator.getGamepads();if(!f)return;const b=f[0],k=["a","b","x","y","lb","rb","lt","rt","map","menu","lstick","rstick","du","dd","dl","dr","xbox"],P=["lx","ly","rx","ry"];b==null||b.buttons.forEach((D,U)=>{const V=k[U];D.pressed?(e(2,w[k[U]]=D.value,w),T[V]&&T[V](),u||e(4,u=!0)):e(2,w[k[U]]=0,w)}),b==null||b.axes.forEach((D,U)=>{e(3,_[P[U]]=D>.01||D<-.01?parseFloat(D.toFixed(3)):0,_)}),n=requestAnimationFrame(c)};return Ye(async()=>{try{c()}catch(f){console.log(f)}}),t.$$set=f=>{"ls"in f&&e(0,m=f.ls),"rs"in f&&e(1,g=f.rs)},t.$$.update=()=>{t.$$.dirty&12&&e(7,r=()=>{let f=_.lx*25,b=_.ly*25,k=_.lx*10,P=_.ly*10,D=1-w.lstick*.05;return e(0,m=Math.round(_.ly*Ue)*-1),`translateX(${f}%) translateY(${b}%) rotateY(${k}deg) rotateX(${P}deg) scale(${D})`}),t.$$.dirty&12&&e(6,l=()=>{let f=_.rx*25,b=_.ry*25,k=_.rx*10,P=_.ry*10,D=1-w.rstick*.05;return e(1,g=Math.round(Math.tan(_.rx)/(Math.PI/2)*Ue)),`translateX(${f}%) translateY(${b}%) rotateY(${k}deg) rotateX(${P}deg) scale(${D})`}),t.$$.dirty&4&&e(5,i=f=>{let b=w[f];return`
			transform: scaleX(${f==="rt"?-b:b}) scaleY(${b}) rotate(-69deg);
			opacity: ${.3+b};
		`})},[m,g,w,_,u,i,l,r,B,y]}class st extends oe{constructor(s){super(),le(this,s,tt,et,re,{ls:0,rs:1})}}function nt(t){let s,e,r,l,i,n,u,m,g,T,w;function _(c){t[4](c)}function B(c){t[5](c)}let y={};return t[0]!==void 0&&(y.ls=t[0]),t[1]!==void 0&&(y.rs=t[1]),m=new st({props:y}),Ce.push(()=>Pe(m,"ls",_)),Ce.push(()=>Pe(m,"rs",B)),{c(){s=v("div"),e=v("div"),r=v("span"),l=H(t[2]),i=v("span"),n=H(t[3]),u=N(),he(m.$$.fragment),this.h()},l(c){s=h(c,"DIV",{class:!0});var f=S(s);e=h(f,"DIV",{class:!0});var b=S(e);r=h(b,"SPAN",{});var k=S(r);l=J(k,t[2]),k.forEach(d),i=h(b,"SPAN",{});var P=S(i);n=J(P,t[3]),P.forEach(d),b.forEach(d),u=I(f),be(m.$$.fragment,f),f.forEach(d),this.h()},h(){p(e,"class","filtered svelte-iezy4t"),p(s,"class","wrap svelte-iezy4t")},m(c,f){q(c,s,f),a(s,e),a(e,r),a(r,l),a(e,i),a(i,n),a(s,u),me(m,s,null),w=!0},p(c,[f]){(!w||f&4)&&Q(l,c[2]),(!w||f&8)&&Q(n,c[3]);const b={};!g&&f&1&&(g=!0,b.ls=c[0],Ne(()=>g=!1)),!T&&f&2&&(T=!0,b.rs=c[1],Ne(()=>T=!1)),m.$set(b)},i(c){w||(_e(m.$$.fragment,c),w=!0)},o(c){ye(m.$$.fragment,c),w=!1},d(c){c&&d(s),Se(m)}}}const ee=254,te=11;function at(t,s,e){let r=0,l=0,i=0,n=0;function u(T,w){T<te&&T>-te?e(2,i=0):e(2,i=T),w<te&&w>-te?e(3,n=0):e(3,n=w);let _=i,B=i;_=_+n,B=B-n,_>ee&&(_=ee),B>ee&&(B=ee),qe({lm:_,rm:B})}function m(T){r=T,e(0,r)}function g(T){l=T,e(1,l)}return t.$$.update=()=>{t.$$.dirty&3&&u(r,l)},[r,l,i,n,m,g]}class bt extends oe{constructor(s){super(),le(this,s,at,nt,re,{})}}function rt(t){let s,e,r,l;return{c(){s=v("div"),e=v("div"),r=v("div"),this.h()},l(i){s=h(i,"DIV",{class:!0});var n=S(s);e=h(n,"DIV",{class:!0});var u=S(e);r=h(u,"DIV",{class:!0,style:!0}),S(r).forEach(d),u.forEach(d),n.forEach(d),this.h()},h(){p(r,"class",l="battery-level "+t[1]+" svelte-xhchq0"),W(r,"height",t[0]+"%"),p(e,"class","battery svelte-xhchq0"),p(s,"class","wrap svelte-xhchq0")},m(i,n){q(i,s,n),a(s,e),a(e,r)},p(i,[n]){n&2&&l!==(l="battery-level "+i[1]+" svelte-xhchq0")&&p(r,"class",l),n&1&&W(r,"height",i[0]+"%")},i:ne,o:ne,d(i){i&&d(s)}}}function ot(t,s,e){let{percent:r}=s,l="";return r<10&&r>0?l="alert":r<30&&r>0?l="warn":r>100?l="charge":l="",t.$$set=i=>{"percent"in i&&e(0,r=i.percent)},[r,l]}class Oe extends oe{constructor(s){super(),le(this,s,ot,rt,re,{percent:0})}}function lt(t){let s,e,r,l,i="Phone",n,u,m,g,T,w="BLE",_,B,y,c,f,b="Gps Acc",k,P=t[0].gps.accuracy+"",D,U;return u=new Oe({props:{percent:t[0].phoneBattery}}),B=new Oe({props:{percent:t[0].bleBattery}}),{c(){s=v("div"),e=v("ul"),r=v("li"),l=v("span"),l.textContent=i,n=N(),he(u.$$.fragment),m=N(),g=v("li"),T=v("span"),T.textContent=w,_=N(),he(B.$$.fragment),y=N(),c=v("li"),f=v("span"),f.textContent=b,k=N(),D=H(P),this.h()},l(V){s=h(V,"DIV",{});var O=S(s);e=h(O,"UL",{});var G=S(e);r=h(G,"LI",{class:!0});var L=S(r);l=h(L,"SPAN",{class:!0,"data-svelte-h":!0}),se(l)!=="svelte-12ymgw7"&&(l.textContent=i),n=I(L),be(u.$$.fragment,L),L.forEach(d),m=I(G),g=h(G,"LI",{class:!0});var $=S(g);T=h($,"SPAN",{class:!0,"data-svelte-h":!0}),se(T)!=="svelte-4zsvbs"&&(T.textContent=w),_=I($),be(B.$$.fragment,$),$.forEach(d),y=I(G),c=h(G,"LI",{class:!0});var M=S(c);f=h(M,"SPAN",{class:!0,"data-svelte-h":!0}),se(f)!=="svelte-16gqpok"&&(f.textContent=b),k=I(M),D=J(M,P),M.forEach(d),G.forEach(d),O.forEach(d),this.h()},h(){p(l,"class","label"),p(r,"class","svelte-1y3lrug"),p(T,"class","label"),p(g,"class","svelte-1y3lrug"),p(f,"class","label"),p(c,"class","svelte-1y3lrug")},m(V,O){q(V,s,O),a(s,e),a(e,r),a(r,l),a(r,n),me(u,r,null),a(e,m),a(e,g),a(g,T),a(g,_),me(B,g,null),a(e,y),a(e,c),a(c,f),a(c,k),a(c,D),U=!0},p(V,[O]){const G={};O&1&&(G.percent=V[0].phoneBattery),u.$set(G);const L={};O&1&&(L.percent=V[0].bleBattery),B.$set(L),(!U||O&1)&&P!==(P=V[0].gps.accuracy+"")&&Q(D,P)},i(V){U||(_e(u.$$.fragment,V),_e(B.$$.fragment,V),U=!0)},o(V){ye(u.$$.fragment,V),ye(B.$$.fragment,V),U=!1},d(V){V&&d(s),Se(u),Se(B)}}}function ct(t,s,e){let r;Ke(t,Z,n=>e(0,r=n));let{isSender:l=!1}=s,i=0;return l&&(navigator.geolocation&&navigator.geolocation.getCurrentPosition(n=>{}),navigator.geolocation.watchPosition(n=>{Z.update(u=>({...u,gps:{lat:n.coords.latitude,lng:n.coords.longitude,alt:n.coords.altitude,accuracy:n.coords.accuracy}}))}),window.DeviceOrientationEvent&&(window.addEventListener("deviceorientation",function(n){i=n.alpha}),Z.update(n=>({...n,compass:i}))),typeof navigator.getBattery<"u"&&navigator.getBattery().then(function(n){Ie(Z,r.phoneBattery=n.level*100,r),n.addEventListener("levelchange",function(){Ie(Z,r.phoneBattery=n.level*100,r)})}).catch(n=>{console.log("battery error",n)}),Qe.battery.onNotification(n=>{We({bleBattery:parseInt(n)})})),t.$$set=n=>{"isSender"in n&&e(1,l=n.isSender)},[r,l]}class mt extends oe{constructor(s){super(),le(this,s,ct,lt,re,{isSender:1})}}export{bt as C,mt as S,vt as a,gt as b,ae as c,Qe as d,ve as e,pt as f,ht as g,we as s};
