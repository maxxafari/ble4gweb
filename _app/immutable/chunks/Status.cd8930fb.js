import{f as Xe,s as oe,n as ne,r as Ye,o as Ke,b as Be,i as Ne,c as Ae,j as Ie}from"./scheduler.396ab924.js";import{S as le,i as ce,s as P,g as v,c as k,h,j as S,f as g,k as p,l as W,F as T,a as j,A as a,C as Pe,m as J,z as se,n as Q,o as Z,G as ke,r as be,u as me,v as _e,d as ye,t as we,w as Se}from"./index.2cee157a.js";import{w as $e}from"./index.7cfe3c3c.js";import{s as H,u as Re}from"./statusStore.c6a4319c.js";const We=t=>{let s,e=!1;return{isConnected:()=>e,connect:async()=>{var N;if(s=await navigator.bluetooth.requestDevice({filters:[{namePrefix:"nrf52"}],optionalServices:t.map(i=>i.serviceId)}),!s.gatt)throw new Error("No GATT server");const c=await((N=s.gatt)==null?void 0:N.connect());if(!c)throw new Error("No connect to GATT server");return await t.forEach(async i=>await i.addServiceTo(c)),e=!0,s.addEventListener("gattserverdisconnected",i=>{console.error("disconnected BLE",i),e=!1}),!0},disconnect:async()=>{var c;await((c=s==null?void 0:s.gatt)==null?void 0:c.disconnect())},bleDevice:s}},Le=t=>{const{name:s,serviceId:e,characteristicId:o,readParser:l,setParser:u}=t;let n,c;const N=async m=>{if(c=m,!c.connected)throw new Error("BLE Server not connected");return n=await(await c.getPrimaryService(e)).getCharacteristic(o),t.isNotifiable&&(await n.startNotifications(),n.addEventListener("characteristicvaluechanged",O=>{const w=O.target;if(!l)throw new Error("readParser not defined");w.value&&y(l(w.value))})),!0};async function i(){if(!l)throw new Error("readParser not defined");return c!=null&&c.connected?await l(await n.readValue()):(console.warn("setVal, no connection",{name:s}),l(new DataView(new ArrayBuffer(0))))}async function b(m){await n.writeValue(m)}async function C(m){if(!u)throw new Error("setParser not defined");if(!(c!=null&&c.connected))return console.error(`${s} setVal, no connection`);const I=u(m);console.log("setVal",{value:m,parsedValue:I}),await n.writeValue(I)}let y=m=>{console.warn("onNotification not implemented:",{name:s,value:m})};return{addServiceTo:N,serviceId:e,getVal:i,setVal:C,setValRaw:b,onNotification:m=>{if(!t.isNotifiable)throw new Error(`${s} Characteristic is not set as notifiable`);y=m}}},Ge=Le({name:"Battery",serviceId:"battery_service",characteristicId:"battery_level",isNotifiable:!0,readParser:t=>t.getUint8(0).toString()}),Me=Le({name:"Leds",serviceId:"a3941db0-a97c-4cf1-943f-a25ff9ba40cd",characteristicId:"5b8c0ab6-a058-4684-b2b6-4a0a692e2d45",isNotifiable:!1,readParser:t=>(console.log("dataView leds",t),t.getInt8(0)+""+t.getInt8(1)),setParser:t=>{if(typeof t=="string"){const[s,e]=t.split("").map(o=>parseInt(o));return new Uint8Array([s,e])}else return console.log("unhandled data setParser",t),new Uint8Array([0,0])}}),He=We([Me,Ge]),Je={...He,leds:Me,battery:Ge},qe="stear",ae=$e({key:qe,lm:0,rm:0}),Qe=t=>!!(typeof t=="object"&&t&&"key"in t&&t.key===qe),je=t=>{ae.update(s=>({...s,...t}))},gt=t=>{console.log("bindStearingStoreToConnDownStream"),t.on("data",s=>{Qe(s)&&je(s)})},pt=t=>{console.log("bindStearingStoreToConnDownStream"),ae.subscribe(e=>{t.send(e)});const s=Xe(ae);t.send(s)},ze="btn",re=$e({key:ze,horn:!1,lights:!1,speedMode:!1});let De;const Fe=t=>{clearTimeout(De),De=setTimeout(()=>{t()},100)},Ze=t=>{re.update(s=>({...s,...t}))},xe=t=>!!(typeof t=="object"&&t&&"key"in t&&t.key===ze),vt=t=>{console.log("bindStatusStoreToConnDownStream"),t.on("data",s=>{xe(s)&&Ze(s)})},ht=t=>{console.log("bindStatusStoreToConnUpStream"),re.subscribe(s=>{Fe(()=>{t.send(s)})})},he=(t,s)=>{console.log("btnPress!"),Fe(()=>{re.update(e=>({...e,[t]:!e[t]})),s||setTimeout(()=>{re.update(e=>({...e,[t]:!1}))},100)})};function Ve(t){let s,e="Gamepad connected",o,l,u,n=t[1].ly+"",c,N,i,b=t[1].rx+"",C;return{c(){s=v("span"),s.textContent=e,o=P(),l=v("div"),u=v("div"),c=J(n),N=P(),i=v("div"),C=J(b),this.h()},l(y){s=h(y,"SPAN",{"data-svelte-h":!0}),se(s)!=="svelte-vjytum"&&(s.textContent=e),o=k(y),l=h(y,"DIV",{class:!0});var f=S(l);u=h(f,"DIV",{class:!0});var m=S(u);c=Q(m,n),m.forEach(g),N=k(f),i=h(f,"DIV",{class:!0});var I=S(i);C=Q(I,b),I.forEach(g),f.forEach(g),this.h()},h(){p(u,"class","svelte-1gg25p3"),p(i,"class","svelte-1gg25p3"),p(l,"class","vals svelte-1gg25p3")},m(y,f){j(y,s,f),j(y,o,f),j(y,l,f),a(l,u),a(u,c),a(l,N),a(l,i),a(i,C)},p(y,f){f&2&&n!==(n=y[1].ly+"")&&Z(c,n),f&2&&b!==(b=y[1].rx+"")&&Z(C,b)},d(y){y&&(g(s),g(o),g(l))}}}function et(t){let s,e,o,l,u,n,c,N,i,b,C,y,f,m,I,O,w,d,_,U,D,B,V,A,L,M,G,ie,z,ue,F,fe,X,de,Y,ge,K,x,pe,R,ee,ve,Ee,$=t[2]&&Ve(t);return{c(){$&&$.c(),s=P(),e=v("section"),o=v("div"),l=P(),u=v("div"),n=v("div"),c=P(),N=v("div"),i=v("div"),b=P(),C=v("button"),y=P(),f=v("button"),m=P(),I=v("button"),O=P(),w=v("button"),d=P(),_=v("button"),U=P(),D=v("button"),B=P(),V=v("button"),A=P(),L=v("button"),M=P(),G=v("button"),ie=P(),z=v("button"),ue=P(),F=v("button"),fe=P(),X=v("button"),de=P(),Y=v("button"),ge=P(),K=v("button"),pe=P(),R=v("button"),this.h()},l(E){$&&$.l(E),s=k(E),e=h(E,"SECTION",{class:!0});var r=S(e);o=h(r,"DIV",{class:!0}),S(o).forEach(g),l=k(r),u=h(r,"DIV",{class:!0});var Te=S(u);n=h(Te,"DIV",{class:!0,style:!0}),S(n).forEach(g),Te.forEach(g),c=k(r),N=h(r,"DIV",{class:!0});var Ce=S(N);i=h(Ce,"DIV",{class:!0,style:!0}),S(i).forEach(g),Ce.forEach(g),b=k(r),C=h(r,"BUTTON",{class:!0}),S(C).forEach(g),y=k(r),f=h(r,"BUTTON",{class:!0}),S(f).forEach(g),m=k(r),I=h(r,"BUTTON",{class:!0}),S(I).forEach(g),O=k(r),w=h(r,"BUTTON",{class:!0}),S(w).forEach(g),d=k(r),_=h(r,"BUTTON",{class:!0}),S(_).forEach(g),U=k(r),D=h(r,"BUTTON",{class:!0}),S(D).forEach(g),B=k(r),V=h(r,"BUTTON",{class:!0}),S(V).forEach(g),A=k(r),L=h(r,"BUTTON",{class:!0}),S(L).forEach(g),M=k(r),G=h(r,"BUTTON",{class:!0}),S(G).forEach(g),ie=k(r),z=h(r,"BUTTON",{class:!0}),S(z).forEach(g),ue=k(r),F=h(r,"BUTTON",{class:!0}),S(F).forEach(g),fe=k(r),X=h(r,"BUTTON",{class:!0}),S(X).forEach(g),de=k(r),Y=h(r,"BUTTON",{class:!0}),S(Y).forEach(g),ge=k(r),K=h(r,"BUTTON",{class:!0,style:!0}),S(K).forEach(g),pe=k(r),R=h(r,"BUTTON",{class:!0,style:!0}),S(R).forEach(g),r.forEach(g),this.h()},h(){p(o,"class","pad svelte-1gg25p3"),p(n,"class","stick svelte-1gg25p3"),W(n,"transform",t[5]()),T(n,"click",t[0].lstick),p(u,"class","well left svelte-1gg25p3"),p(i,"class","stick svelte-1gg25p3"),W(i,"transform",t[4]()),T(i,"click",t[0].rstick),p(N,"class","well right svelte-1gg25p3"),p(C,"class","button a svelte-1gg25p3"),T(C,"on",t[0].a),p(f,"class","button b svelte-1gg25p3"),T(f,"on",t[0].b),p(I,"class","button x svelte-1gg25p3"),T(I,"on",t[0].x),p(w,"class","button y svelte-1gg25p3"),T(w,"on",t[0].y),p(_,"class","button map svelte-1gg25p3"),T(_,"on",t[0].map),p(D,"class","button menu svelte-1gg25p3"),T(D,"on",t[0].menu),p(V,"class","button xbox svelte-1gg25p3"),T(V,"on",t[0].xbox),p(L,"class","dpad du svelte-1gg25p3"),T(L,"on",t[0].du),p(G,"class","dpad dr svelte-1gg25p3"),T(G,"on",t[0].dr),p(z,"class","dpad dd svelte-1gg25p3"),T(z,"on",t[0].dd),p(F,"class","dpad dl svelte-1gg25p3"),T(F,"on",t[0].dl),p(X,"class","bumper left svelte-1gg25p3"),T(X,"on",t[0].lb),p(Y,"class","bumper right svelte-1gg25p3"),T(Y,"on",t[0].rb),p(K,"class","trigger left svelte-1gg25p3"),p(K,"style",x=t[3]("lt")),p(R,"class","trigger right svelte-1gg25p3"),p(R,"style",ee=t[3]("rt")),p(e,"class","controller svelte-1gg25p3"),T(e,"connected",t[2])},m(E,r){$&&$.m(E,r),j(E,s,r),j(E,e,r),a(e,o),a(e,l),a(e,u),a(u,n),a(e,c),a(e,N),a(N,i),a(e,b),a(e,C),a(e,y),a(e,f),a(e,m),a(e,I),a(e,O),a(e,w),a(e,d),a(e,_),a(e,U),a(e,D),a(e,B),a(e,V),a(e,A),a(e,L),a(e,M),a(e,G),a(e,ie),a(e,z),a(e,ue),a(e,F),a(e,fe),a(e,X),a(e,de),a(e,Y),a(e,ge),a(e,K),a(e,pe),a(e,R),ve||(Ee=[Pe(window,"gamepadconnected",t[6]),Pe(window,"gamepaddisconnected",t[7])],ve=!0)},p(E,[r]){E[2]?$?$.p(E,r):($=Ve(E),$.c(),$.m(s.parentNode,s)):$&&($.d(1),$=null),r&32&&W(n,"transform",E[5]()),r&1&&T(n,"click",E[0].lstick),r&16&&W(i,"transform",E[4]()),r&1&&T(i,"click",E[0].rstick),r&1&&T(C,"on",E[0].a),r&1&&T(f,"on",E[0].b),r&1&&T(I,"on",E[0].x),r&1&&T(w,"on",E[0].y),r&1&&T(_,"on",E[0].map),r&1&&T(D,"on",E[0].menu),r&1&&T(V,"on",E[0].xbox),r&1&&T(L,"on",E[0].du),r&1&&T(G,"on",E[0].dr),r&1&&T(z,"on",E[0].dd),r&1&&T(F,"on",E[0].dl),r&1&&T(X,"on",E[0].lb),r&1&&T(Y,"on",E[0].rb),r&8&&x!==(x=E[3]("lt"))&&p(K,"style",x),r&8&&ee!==(ee=E[3]("rt"))&&p(R,"style",ee),r&4&&T(e,"connected",E[2])},i:ne,o:ne,d(E){E&&(g(s),g(e)),$&&$.d(E),ve=!1,Ye(Ee)}}}const Ue=254,te=.05;function tt(t,s,e){let o,l,u,n=0,c=!1;const N=Ue*.05*Math.PI;let{ls:i=0}=s,{rs:b=0}=s;function C(d){return d<te&&d>-te?0:(d=d>0?d-te:d+te,Math.floor(Math.tan(d)/(Math.PI/2)*(Ue+N)))}const y={y:()=>{he("horn",!1)},x:()=>{he("lights",!0)},lt:()=>{he("speedMode",!0)}},f={a:0,b:0,x:0,y:0,lb:0,rb:0,lt:0,rt:0,map:0,menu:0,lstick:0,rstick:0,du:0,dd:0,dl:0,dr:0,xbox:0},m={lx:0,ly:0,rx:0,ry:0},I=()=>{w(),e(2,c=!0),console.log("GamePad connected")},O=()=>{cancelAnimationFrame(n),e(2,c=!1),console.log("GamePad lost connection")},w=()=>{const d=navigator.getGamepads();if(!d)return;const _=d[0],U=["a","b","x","y","lb","rb","lt","rt","map","menu","lstick","rstick","du","dd","dl","dr","xbox"],D=["lx","ly","rx","ry"];_==null||_.buttons.forEach((B,V)=>{const A=U[V];B.pressed?(e(0,f[U[V]]=B.value,f),y[A]&&y[A](),c||e(2,c=!0)):e(0,f[U[V]]=0,f)}),_==null||_.axes.forEach((B,V)=>{e(1,m[D[V]]=B>.01||B<-.01?parseFloat(B.toFixed(3)):0,m)}),n=requestAnimationFrame(w)};return Ke(async()=>{try{w()}catch(d){console.log(d)}}),t.$$set=d=>{"ls"in d&&e(8,i=d.ls),"rs"in d&&e(9,b=d.rs)},t.$$.update=()=>{t.$$.dirty&3&&e(5,o=()=>{let d=m.lx*25,_=m.ly*25,U=m.lx*10,D=m.ly*10,B=1-f.lstick*.05;return e(8,i=C(m.ly)),`translateX(${d}%) translateY(${_}%) rotateY(${U}deg) rotateX(${D}deg) scale(${B})`}),t.$$.dirty&3&&e(4,l=()=>{let d=m.rx*25,_=m.ry*25,U=m.rx*10,D=m.ry*10,B=1-f.rstick*.05;return e(9,b=C(m.rx)),`translateX(${d}%) translateY(${_}%) rotateY(${U}deg) rotateX(${D}deg) scale(${B})`}),t.$$.dirty&1&&e(3,u=d=>{let _=f[d];return`
			transform: scaleX(${d==="rt"?-_:_}) scaleY(${_}) rotate(-69deg);
			opacity: ${.3+_};
		`})},[f,m,c,u,l,o,I,O,i,b]}class st extends le{constructor(s){super(),ce(this,s,tt,et,oe,{ls:8,rs:9})}}function nt(t){let s,e,o,l=t[2].lm+"",u,n,c=t[2].rm+"",N,i,b,C,y,f;function m(w){t[3](w)}function I(w){t[4](w)}let O={};return t[0]!==void 0&&(O.ls=t[0]),t[1]!==void 0&&(O.rs=t[1]),b=new st({props:O}),Be.push(()=>ke(b,"ls",m)),Be.push(()=>ke(b,"rs",I)),{c(){s=v("div"),e=v("div"),o=v("span"),u=J(l),n=v("span"),N=J(c),i=P(),be(b.$$.fragment),this.h()},l(w){s=h(w,"DIV",{class:!0});var d=S(s);e=h(d,"DIV",{class:!0});var _=S(e);o=h(_,"SPAN",{});var U=S(o);u=Q(U,l),U.forEach(g),n=h(_,"SPAN",{});var D=S(n);N=Q(D,c),D.forEach(g),_.forEach(g),i=k(d),me(b.$$.fragment,d),d.forEach(g),this.h()},h(){p(e,"class","filtered svelte-iezy4t"),p(s,"class","wrap svelte-iezy4t")},m(w,d){j(w,s,d),a(s,e),a(e,o),a(o,u),a(e,n),a(n,N),a(s,i),_e(b,s,null),f=!0},p(w,[d]){(!f||d&4)&&l!==(l=w[2].lm+"")&&Z(u,l),(!f||d&4)&&c!==(c=w[2].rm+"")&&Z(N,c);const _={};!C&&d&1&&(C=!0,_.ls=w[0],Ne(()=>C=!1)),!y&&d&2&&(y=!0,_.rs=w[1],Ne(()=>y=!1)),b.$set(_)},i(w){f||(ye(b.$$.fragment,w),f=!0)},o(w){we(b.$$.fragment,w),f=!1},d(w){w&&g(s),Se(b)}}}const q=254;function at(t,s,e){let o;Ae(t,ae,i=>e(2,o=i));let l=0,u=0;function n(i,b){let C=i+b,y=i-b;C>q&&(C=q),y>q&&(y=q),C<-q&&(C=-q),y<-q&&(y=-q),je({lm:C,rm:y})}function c(i){l=i,e(0,l)}function N(i){u=i,e(1,u)}return t.$$.update=()=>{t.$$.dirty&3&&n(l,u)},[l,u,o,c,N]}class bt extends le{constructor(s){super(),ce(this,s,at,nt,oe,{})}}function rt(t){let s,e,o,l;return{c(){s=v("div"),e=v("div"),o=v("div"),this.h()},l(u){s=h(u,"DIV",{class:!0});var n=S(s);e=h(n,"DIV",{class:!0});var c=S(e);o=h(c,"DIV",{class:!0,style:!0}),S(o).forEach(g),c.forEach(g),n.forEach(g),this.h()},h(){p(o,"class",l="battery-level "+t[1]+" svelte-xhchq0"),W(o,"height",t[0]+"%"),p(e,"class","battery svelte-xhchq0"),p(s,"class","wrap svelte-xhchq0")},m(u,n){j(u,s,n),a(s,e),a(e,o)},p(u,[n]){n&2&&l!==(l="battery-level "+u[1]+" svelte-xhchq0")&&p(o,"class",l),n&1&&W(o,"height",u[0]+"%")},i:ne,o:ne,d(u){u&&g(s)}}}function ot(t,s,e){let{percent:o}=s,l="";return o<10&&o>0?l="alert":o<30&&o>0?l="warn":o>100?l="charge":l="",t.$$set=u=>{"percent"in u&&e(0,o=u.percent)},[o,l]}class Oe extends le{constructor(s){super(),ce(this,s,ot,rt,oe,{percent:0})}}function lt(t){let s,e,o,l,u="Phone",n,c,N,i,b,C="BLE",y,f,m,I,O,w="Gps Acc",d,_=t[0].gps.accuracy+"",U,D;return c=new Oe({props:{percent:t[0].phoneBattery}}),f=new Oe({props:{percent:t[0].bleBattery}}),{c(){s=v("div"),e=v("ul"),o=v("li"),l=v("span"),l.textContent=u,n=P(),be(c.$$.fragment),N=P(),i=v("li"),b=v("span"),b.textContent=C,y=P(),be(f.$$.fragment),m=P(),I=v("li"),O=v("span"),O.textContent=w,d=P(),U=J(_),this.h()},l(B){s=h(B,"DIV",{});var V=S(s);e=h(V,"UL",{});var A=S(e);o=h(A,"LI",{class:!0});var L=S(o);l=h(L,"SPAN",{class:!0,"data-svelte-h":!0}),se(l)!=="svelte-12ymgw7"&&(l.textContent=u),n=k(L),me(c.$$.fragment,L),L.forEach(g),N=k(A),i=h(A,"LI",{class:!0});var M=S(i);b=h(M,"SPAN",{class:!0,"data-svelte-h":!0}),se(b)!=="svelte-4zsvbs"&&(b.textContent=C),y=k(M),me(f.$$.fragment,M),M.forEach(g),m=k(A),I=h(A,"LI",{class:!0});var G=S(I);O=h(G,"SPAN",{class:!0,"data-svelte-h":!0}),se(O)!=="svelte-16gqpok"&&(O.textContent=w),d=k(G),U=Q(G,_),G.forEach(g),A.forEach(g),V.forEach(g),this.h()},h(){p(l,"class","label"),p(o,"class","svelte-1y3lrug"),p(b,"class","label"),p(i,"class","svelte-1y3lrug"),p(O,"class","label"),p(I,"class","svelte-1y3lrug")},m(B,V){j(B,s,V),a(s,e),a(e,o),a(o,l),a(o,n),_e(c,o,null),a(e,N),a(e,i),a(i,b),a(i,y),_e(f,i,null),a(e,m),a(e,I),a(I,O),a(I,d),a(I,U),D=!0},p(B,[V]){const A={};V&1&&(A.percent=B[0].phoneBattery),c.$set(A);const L={};V&1&&(L.percent=B[0].bleBattery),f.$set(L),(!D||V&1)&&_!==(_=B[0].gps.accuracy+"")&&Z(U,_)},i(B){D||(ye(c.$$.fragment,B),ye(f.$$.fragment,B),D=!0)},o(B){we(c.$$.fragment,B),we(f.$$.fragment,B),D=!1},d(B){B&&g(s),Se(c),Se(f)}}}function ct(t,s,e){let o;Ae(t,H,n=>e(0,o=n));let{isSender:l=!1}=s,u=0;return l&&(navigator.geolocation&&navigator.geolocation.getCurrentPosition(n=>{}),navigator.geolocation.watchPosition(n=>{H.update(c=>({...c,gps:{lat:n.coords.latitude,lng:n.coords.longitude,alt:n.coords.altitude,accuracy:n.coords.accuracy}}))}),window.DeviceOrientationEvent&&(window.addEventListener("deviceorientation",function(n){u=n.alpha}),H.update(n=>({...n,compass:u}))),typeof navigator.getBattery<"u"&&navigator.getBattery().then(function(n){Ie(H,o.phoneBattery=n.level*100,o),n.addEventListener("levelchange",function(){Ie(H,o.phoneBattery=n.level*100,o)})}).catch(n=>{console.log("battery error",n)}),Je.battery.onNotification(n=>{Re({bleBattery:parseInt(n)})})),t.$$set=n=>{"isSender"in n&&e(1,l=n.isSender)},[o,l]}class mt extends le{constructor(s){super(),ce(this,s,ct,lt,oe,{isSender:1})}}export{bt as C,mt as S,vt as a,gt as b,re as c,Je as d,he as e,pt as f,ht as g,ae as s};
