import{f as A,s as oe,c as ae,n as H}from"../chunks/scheduler.45f36ff2.js";import{S as re,i as ie,s as C,g as u,r as K,B as le,f as b,c as g,h as p,j as O,z as T,u as Q,k as N,a as E,A as d,v as R,C as W,d as X,t as Y,w as Z}from"../chunks/index.3c897206.js";import{b as se,S as ce,C as de,d as fe}from"../chunks/Status.a9f40a50.js";import{p as ne,e as ue,c as pe,b as me,a as he}from"../chunks/peers.5bcda608.js";import{b as _e}from"../chunks/statusStore.c9e49bbf.js";import{w as ve}from"../chunks/index.fd39fc71.js";import{b as Ce}from"../chunks/transferToBle.da5e3624.js";const ge=!1,be=!0,Ie=Object.freeze(Object.defineProperty({__proto__:null,prerender:be,ssr:ge},Symbol.toStringTag,{value:"Module"})),q=async o=>{const t=A(w).peer;if(!t)throw new Error("Peer is null when calling p2");const e=t.connect(ne);e.once("open",()=>{me(e,o),_e(e),se(e)}),e.once("close",()=>{console.info("data connection closed calling p2 again..."),q(o)}),setTimeout(()=>{var n,r;console.info("checking if peer2 is connected: ",(n=e.peerConnection)==null?void 0:n.connectionState),["connecting","connected"].includes((r=e.peerConnection)==null?void 0:r.connectionState)||(e.removeAllListeners(),console.info("retrying connection to peer2"),q(o))},8e3)},ke=async o=>{console.info("Creating new peer1"),await pe(he,o);const t=A(o).peer;if(!t)throw new Error("Peer is null when calling p2");t==null||t.on("error",e=>{e.type==="peer-unavailable"&&console.log("peer unavailable")}),t==null||t.once("open",()=>{q(o)})},w=ve(ue("peer1"),()=>(console.info("new subscription for peer1"),A(w).peer===null&&ke(w),()=>{console.info("No subscription  peer1")}));w.subscribe(({peer:o,mediaStream:t,mediaConn:e})=>{if(t&&o&&!e){console.log("mediaStream changed");const n=o==null?void 0:o.call(ne,t);w.update(r=>({...r,mediaConn:n}))}else!t&&e&&(console.log("mediaStream cleared"),e.close(),w.update(n=>({...n,mediaConn:null})))});function Se(o){let t,e="Connect BLE",n,r;return{c(){t=u("button"),t.textContent=e},l(l){t=p(l,"BUTTON",{"data-svelte-h":!0}),T(t)!=="svelte-p8uxjk"&&(t.textContent=e)},m(l,m){E(l,t,m),n||(r=W(t,"click",o[4]),n=!0)},p:H,d(l){l&&b(t),n=!1,r()}}}function we(o){let t,e="BLE connected";return{c(){t=u("p"),t.textContent=e},l(n){t=p(n,"P",{"data-svelte-h":!0}),T(t)!=="svelte-ppi2h6"&&(t.textContent=e)},m(n,r){E(n,t,r)},p:H,d(n){n&&b(t)}}}function ee(o){let t,e="<h4>Calling peer2...</h4>";return{c(){t=u("div"),t.innerHTML=e},l(n){t=p(n,"DIV",{"data-svelte-h":!0}),T(t)!=="svelte-1jdsk8a"&&(t.innerHTML=e)},m(n,r){E(n,t,r)},d(n){n&&b(t)}}}function te(o){let t,e,n="Connected to Peer2",r,l,m="Send data",k,h;return{c(){t=u("div"),e=u("h4"),e.textContent=n,r=C(),l=u("button"),l.textContent=m},l(v){t=p(v,"DIV",{});var a=O(t);e=p(a,"H4",{"data-svelte-h":!0}),T(e)!=="svelte-1n8zg7s"&&(e.textContent=n),r=g(a),l=p(a,"BUTTON",{"data-svelte-h":!0}),T(l)!=="svelte-eqb3bi"&&(l.textContent=m),a.forEach(b)},m(v,a){E(v,t,a),d(t,e),d(t,r),d(t,l),k||(h=W(l,"click",o[6]),k=!0)},p:H,d(v){v&&b(t),k=!1,h()}}}function xe(o){let t,e,n,r,l="BLE device",m,k,h,v="Caller (initiator)",a,S,F="Use video",U,x,j,L,B,P,V,$,D,z,G;function J(i,y){return i[1]?we:Se}let I=J(o),_=I(o),f=!o[2].dataConn&&ee(),s=o[2].dataConn&&te(o);return P=new ce({props:{isSender:!0}}),$=new de({}),{c(){t=C(),e=u("div"),n=u("div"),r=u("p"),r.textContent=l,m=C(),_.c(),k=C(),h=u("p"),h.textContent=v,a=C(),S=u("label"),S.textContent=F,U=C(),x=u("input"),j=C(),f&&f.c(),L=C(),s&&s.c(),B=C(),K(P.$$.fragment),V=C(),K($.$$.fragment),this.h()},l(i){le("svelte-czx9hh",document.head).forEach(b),t=g(i),e=p(i,"DIV",{});var c=O(e);n=p(c,"DIV",{});var M=O(n);r=p(M,"P",{"data-svelte-h":!0}),T(r)!=="svelte-r1r1cb"&&(r.textContent=l),m=g(M),_.l(M),M.forEach(b),k=g(c),h=p(c,"P",{"data-svelte-h":!0}),T(h)!=="svelte-1id8pt1"&&(h.textContent=v),a=g(c),S=p(c,"LABEL",{for:!0,"data-svelte-h":!0}),T(S)!=="svelte-eeyfdt"&&(S.textContent=F),U=g(c),x=p(c,"INPUT",{type:!0,id:!0}),j=g(c),f&&f.l(c),L=g(c),s&&s.l(c),B=g(c),Q(P.$$.fragment,c),V=g(c),Q($.$$.fragment,c),c.forEach(b),this.h()},h(){document.title="Peer1",N(S,"for","use-video"),N(x,"type","checkbox"),N(x,"id","use-video")},m(i,y){E(i,t,y),E(i,e,y),d(e,n),d(n,r),d(n,m),_.m(n,null),d(e,k),d(e,h),d(e,a),d(e,S),d(e,U),d(e,x),x.checked=o[0],d(e,j),f&&f.m(e,null),d(e,L),s&&s.m(e,null),d(e,B),R(P,e,null),d(e,V),R($,e,null),D=!0,z||(G=W(x,"change",o[5]),z=!0)},p(i,[y]){I===(I=J(i))&&_?_.p(i,y):(_.d(1),_=I(i),_&&(_.c(),_.m(n,null))),y&1&&(x.checked=i[0]),i[2].dataConn?f&&(f.d(1),f=null):f||(f=ee(),f.c(),f.m(e,L)),i[2].dataConn?s?s.p(i,y):(s=te(i),s.c(),s.m(e,B)):s&&(s.d(1),s=null)},i(i){D||(X(P.$$.fragment,i),X($.$$.fragment,i),D=!0)},o(i){Y(P.$$.fragment,i),Y($.$$.fragment,i),D=!1},d(i){i&&(b(t),b(e)),_.d(),f&&f.d(),s&&s.d(),Z(P),Z($),z=!1,G()}}}function ye(o,t,e){let n;ae(o,w,a=>e(2,n=a));let r=!1,l=!0;async function m(){const a=await fe.connect();e(1,r=a)}navigator.wakeLock.request("screen").then(a=>{}).catch(a=>{console.log("wakeLock error",a)}),Ce();const k=()=>m();function h(){l=this.checked,e(0,l)}const v=()=>{var a;return(a=n.dataConn)==null?void 0:a.send({message:"ping!",date:new Date})};return o.$$.update=()=>{o.$$.dirty&1&&(l&&navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(a=>{w.update(S=>({...S,mediaStream:a}))}).catch(a=>{e(0,l=!1),console.log("getUserMedia error",a)}),l||w.update(a=>({...a,mediaStream:null})))},[l,r,n,m,k,h,v]}class Me extends re{constructor(t){super(),ie(this,t,ye,xe,oe,{})}}export{Me as component,Ie as universal};
