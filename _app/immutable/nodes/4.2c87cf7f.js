import{f as X,s as te,c as G,n as Z}from"../chunks/scheduler.52935eb4.js";import{S as ne,i as oe,s as w,g as b,r as ae,B as le,f as x,c as E,h as S,j as H,z as M,u as re,k as $,a as z,A as i,v as ie,C as F,d as se,t as ce,w as de,m as q,n as A,o as R}from"../chunks/index.573d0439.js";import{p as ee,e as ue,c as fe,b as pe,a as me,d as _e,S as he,s as J,f as K}from"../chunks/peers.83dbae8f.js";import{b as ve}from"../chunks/statusStore.04bd4373.js";import{w as ge}from"../chunks/index.c5ad5140.js";const Ce=!1,be=!0,De=Object.freeze(Object.defineProperty({__proto__:null,prerender:be,ssr:Ce},Symbol.toStringTag,{value:"Module"})),W=async o=>{const e=X(D).peer;if(!e)throw new Error("Peer is null when calling p2");const t=e.connect(ee);t.once("open",()=>{pe(t,o),ve(t),me(t)}),t.once("close",()=>{console.info("data connection closed calling p2 again..."),W(o)}),setTimeout(()=>{var n,l;console.info("checking if peer2 is connected: ",(n=t.peerConnection)==null?void 0:n.connectionState),["connecting","connected"].includes((l=t.peerConnection)==null?void 0:l.connectionState)||(t.removeAllListeners(),console.info("retrying connection to peer2"),W(o))},8e3)},Se=async o=>{console.info("Creating new peer1"),await fe(_e,o);const e=X(o).peer;if(!e)throw new Error("Peer is null when calling p2");e==null||e.on("error",t=>{t.type==="peer-unavailable"&&console.log("peer unavailable")}),e==null||e.once("open",()=>{W(o)})},D=ge(ue("peer1"),()=>(console.info("new subscription for peer1"),X(D).peer===null&&Se(D),()=>{console.info("No subscription  peer1")}));D.subscribe(({peer:o,mediaStream:e,mediaConn:t})=>{if(e&&o&&!t){console.log("mediaStream changed");const n=o==null?void 0:o.call(ee,e);D.update(l=>({...l,mediaConn:n}))}else!e&&t&&(console.log("mediaStream cleared"),t.close(),D.update(n=>({...n,mediaConn:null})))});function ke(o){let e,t="Connect BLE",n,l;return{c(){e=b("button"),e.textContent=t},l(r){e=S(r,"BUTTON",{"data-svelte-h":!0}),M(e)!=="svelte-p8uxjk"&&(e.textContent=t)},m(r,c){z(r,e,c),n||(l=F(e,"click",o[5]),n=!0)},p:Z,d(r){r&&x(e),n=!1,l()}}}function we(o){let e,t="BLE connected";return{c(){e=b("p"),e.textContent=t},l(n){e=S(n,"P",{"data-svelte-h":!0}),M(e)!=="svelte-ppi2h6"&&(e.textContent=t)},m(n,l){z(n,e,l)},p:Z,d(n){n&&x(e)}}}function Q(o){let e,t="<h4>Calling peer2...</h4>";return{c(){e=b("div"),e.innerHTML=t},l(n){e=S(n,"DIV",{"data-svelte-h":!0}),M(e)!=="svelte-1jdsk8a"&&(e.innerHTML=t)},m(n,l){z(n,e,l)},d(n){n&&x(e)}}}function Y(o){let e,t,n="Connected to Peer2",l,r,c,k=o[3].dir+"",_,I,P=o[3].gear+"",h,a,g=o[3].speed+"",u,B,f,V="Send data",y,j;return{c(){e=b("div"),t=b("h4"),t.textContent=n,l=w(),r=b("p"),c=q("steering: "),_=q(k),I=w(),h=q(P),a=w(),u=q(g),B=w(),f=b("button"),f.textContent=V},l(C){e=S(C,"DIV",{});var p=H(e);t=S(p,"H4",{"data-svelte-h":!0}),M(t)!=="svelte-1n8zg7s"&&(t.textContent=n),l=E(p),r=S(p,"P",{});var L=H(r);c=A(L,"steering: "),_=A(L,k),I=E(L),h=A(L,P),a=E(L),u=A(L,g),L.forEach(x),B=E(p),f=S(p,"BUTTON",{"data-svelte-h":!0}),M(f)!=="svelte-eqb3bi"&&(f.textContent=V),p.forEach(x)},m(C,p){z(C,e,p),i(e,t),i(e,l),i(e,r),i(r,c),i(r,_),i(r,I),i(r,h),i(r,a),i(r,u),i(e,B),i(e,f),y||(j=F(f,"click",o[7]),y=!0)},p(C,p){p&8&&k!==(k=C[3].dir+"")&&R(_,k),p&8&&P!==(P=C[3].gear+"")&&R(h,P),p&8&&g!==(g=C[3].speed+"")&&R(u,g)},d(C){C&&x(e),y=!1,j()}}}function Ee(o){let e,t,n,l,r="BLE device",c,k,_,I="Caller (initiator)",P,h,a="Use video",g,u,B,f,V,y,j,C,p;function L(s,U){return s[1]?we:ke}let N=L(o),T=N(o),m=!o[2].dataConn&&Q(),d=o[2].dataConn&&Y(o);return y=new he({props:{isSender:!0}}),{c(){e=w(),t=b("div"),n=b("div"),l=b("p"),l.textContent=r,c=w(),T.c(),k=w(),_=b("p"),_.textContent=I,P=w(),h=b("label"),h.textContent=a,g=w(),u=b("input"),B=w(),m&&m.c(),f=w(),d&&d.c(),V=w(),ae(y.$$.fragment),this.h()},l(s){le("svelte-czx9hh",document.head).forEach(x),e=E(s),t=S(s,"DIV",{});var v=H(t);n=S(v,"DIV",{});var O=H(n);l=S(O,"P",{"data-svelte-h":!0}),M(l)!=="svelte-r1r1cb"&&(l.textContent=r),c=E(O),T.l(O),O.forEach(x),k=E(v),_=S(v,"P",{"data-svelte-h":!0}),M(_)!=="svelte-1id8pt1"&&(_.textContent=I),P=E(v),h=S(v,"LABEL",{for:!0,"data-svelte-h":!0}),M(h)!=="svelte-eeyfdt"&&(h.textContent=a),g=E(v),u=S(v,"INPUT",{type:!0,id:!0}),B=E(v),m&&m.l(v),f=E(v),d&&d.l(v),V=E(v),re(y.$$.fragment,v),v.forEach(x),this.h()},h(){document.title="Peer1",$(h,"for","use-video"),$(u,"type","checkbox"),$(u,"id","use-video")},m(s,U){z(s,e,U),z(s,t,U),i(t,n),i(n,l),i(n,c),T.m(n,null),i(t,k),i(t,_),i(t,P),i(t,h),i(t,g),i(t,u),u.checked=o[0],i(t,B),m&&m.m(t,null),i(t,f),d&&d.m(t,null),i(t,V),ie(y,t,null),j=!0,C||(p=F(u,"change",o[6]),C=!0)},p(s,[U]){N===(N=L(s))&&T?T.p(s,U):(T.d(1),T=N(s),T&&(T.c(),T.m(n,null))),U&1&&(u.checked=s[0]),s[2].dataConn?m&&(m.d(1),m=null):m||(m=Q(),m.c(),m.m(t,f)),s[2].dataConn?d?d.p(s,U):(d=Y(s),d.c(),d.m(t,V)):d&&(d.d(1),d=null)},i(s){j||(se(y.$$.fragment,s),j=!0)},o(s){ce(y.$$.fragment,s),j=!1},d(s){s&&(x(e),x(t)),T.d(),m&&m.d(),d&&d.d(),de(y),C=!1,p()}}}function Pe(o,e,t){let n,l;G(o,D,a=>t(2,n=a)),G(o,J,a=>t(3,l=a));let r=!1,c=!0,k=null;async function _(){const a=await K.connect();t(1,r=a)}navigator.wakeLock.request("screen").then(a=>{}).catch(a=>{console.log("wakeLock error",a)}),k||(k=J.subscribe(a=>{if(console.log("stearingStore upd:",a),!r){console.warn("command not sent, BLE not connected");return}console.info("sending command to BLE device");const{gear:g,dir:u,speed:B}=a,f=new TextEncoder().encode("X"+g+u+"P");f[3]=B,K.leds.setValRaw(f.buffer)}));const I=()=>_();function P(){c=this.checked,t(0,c)}const h=()=>{var a;return(a=n.dataConn)==null?void 0:a.send({message:"ping!",date:new Date})};return o.$$.update=()=>{o.$$.dirty&1&&(c&&navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(a=>{D.update(g=>({...g,mediaStream:a}))}).catch(a=>{t(0,c=!1),console.log("getUserMedia error",a)}),c||D.update(a=>({...a,mediaStream:null})))},[c,r,n,l,_,I,P,h]}class Ie extends ne{constructor(e){super(),oe(this,e,Pe,Ee,te,{})}}export{Ie as component,De as universal};
