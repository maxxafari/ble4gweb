import{f as z,s as Q,n as M,c as R}from"../chunks/scheduler.aa60952c.js";import{S as X,i as Y,s as y,g as h,B as Z,f as k,c as P,h as m,j as N,y as T,k as V,a as I,A as c,C as A,m as W,n as F,o as $}from"../chunks/index.a7391ef6.js";import{d as ee}from"../chunks/device.84554f9d.js";import{p as K,e as te,c as ne,b as oe,a as le}from"../chunks/peers.c88dee28.js";import{d as ae,w as ie}from"../chunks/index.9adb9ad6.js";const se=!1,ce=!0,ge=Object.freeze(Object.defineProperty({__proto__:null,prerender:ce,ssr:se},Symbol.toStringTag,{value:"Module"})),O=async o=>{const e=z(x).peer;if(!e)throw new Error("Peer is null when calling p2");const t=e.connect(K);t.once("open",()=>{oe(t,o)}),t.once("close",()=>{console.info("data connection closed calling p2 again..."),O(o)}),setTimeout(()=>{var n,l;console.info("checking if peer2 is connected: ",(n=t.peerConnection)==null?void 0:n.connectionState),["connecting","connected"].includes((l=t.peerConnection)==null?void 0:l.connectionState)||(t.removeAllListeners(),console.info("retrying connection to peer2"),O(o))},8e3)},re=async o=>{console.info("Creating new peer1"),await ne(le,o);const e=z(x).peer;if(!e)throw new Error("Peer is null when calling p2");e==null||e.on("error",t=>{t.type==="peer-unavailable"&&console.log("peer unavailable")}),e==null||e.once("open",()=>{O(o)})},x=ie(te,()=>(console.info("new subscription for peer1"),z(x).peer===null&&re(x),()=>{console.info("No subscription  peer1")}));x.subscribe(({peer:o,mediaStream:e,mediaConn:t})=>{if(e&&o&&!t){console.log("mediaStream changed");const n=o==null?void 0:o.call(K,e);x.update(l=>({...l,mediaConn:n}))}else!e&&t&&(console.log("mediaStream cleared"),t.close(),x.update(n=>({...n,mediaConn:null})))});const de=ae(x,o=>o.lastCommand);function fe(o){let e,t="Connect BLE",n,l;return{c(){e=h("button"),e.textContent=t},l(i){e=m(i,"BUTTON",{"data-svelte-h":!0}),T(e)!=="svelte-p8uxjk"&&(e.textContent=t)},m(i,_){I(i,e,_),n||(l=A(e,"click",o[4]),n=!0)},p:M,d(i){i&&k(e),n=!1,l()}}}function ue(o){let e,t="Not connected";return{c(){e=h("p"),e.textContent=t},l(n){e=m(n,"P",{"data-svelte-h":!0}),T(e)!=="svelte-1cfn932"&&(e.textContent=t)},m(n,l){I(n,e,l)},p:M,d(n){n&&k(e)}}}function G(o){let e,t="<h4>Calling peer2...</h4>";return{c(){e=h("div"),e.innerHTML=t},l(n){e=m(n,"DIV",{"data-svelte-h":!0}),T(e)!=="svelte-1jdsk8a"&&(e.innerHTML=t)},m(n,l){I(n,e,l)},d(n){n&&k(e)}}}function J(o){let e,t,n="Connected to Peer2",l,i,_,b=o[2].dataConn?"true":"false",p,w,a,v="Send data",L,B;return{c(){e=h("div"),t=h("h4"),t.textContent=n,l=y(),i=h("p"),_=W("has dataConn: "),p=W(b),w=y(),a=h("button"),a.textContent=v},l(r){e=m(r,"DIV",{});var u=N(e);t=m(u,"H4",{"data-svelte-h":!0}),T(t)!=="svelte-1n8zg7s"&&(t.textContent=n),l=P(u),i=m(u,"P",{});var S=N(i);_=F(S,"has dataConn: "),p=F(S,b),S.forEach(k),w=P(u),a=m(u,"BUTTON",{"data-svelte-h":!0}),T(a)!=="svelte-eqb3bi"&&(a.textContent=v),u.forEach(k)},m(r,u){I(r,e,u),c(e,t),c(e,l),c(e,i),c(i,_),c(i,p),c(e,w),c(e,a),L||(B=A(a,"click",o[6]),L=!0)},p(r,u){u&4&&b!==(b=r[2].dataConn?"true":"false")&&$(p,b)},d(r){r&&k(e),L=!1,B()}}}function pe(o){let e,t,n,l,i="BLE device",_,b,p,w="Caller (initiator)",a,v,L="Use video",B,r,u,S,U,H;function q(s,E){return s[1]?ue:fe}let D=q(o),g=D(o),f=!o[2].connected&&G(),d=o[2].dataConn&&J(o);return{c(){e=y(),t=h("div"),n=h("div"),l=h("p"),l.textContent=i,_=y(),g.c(),b=y(),p=h("p"),p.textContent=w,a=y(),v=h("label"),v.textContent=L,B=y(),r=h("input"),u=y(),f&&f.c(),S=y(),d&&d.c(),this.h()},l(s){Z("svelte-czx9hh",document.head).forEach(k),e=P(s),t=m(s,"DIV",{});var C=N(t);n=m(C,"DIV",{});var j=N(n);l=m(j,"P",{"data-svelte-h":!0}),T(l)!=="svelte-r1r1cb"&&(l.textContent=i),_=P(j),g.l(j),j.forEach(k),b=P(C),p=m(C,"P",{"data-svelte-h":!0}),T(p)!=="svelte-1id8pt1"&&(p.textContent=w),a=P(C),v=m(C,"LABEL",{for:!0,"data-svelte-h":!0}),T(v)!=="svelte-eeyfdt"&&(v.textContent=L),B=P(C),r=m(C,"INPUT",{type:!0,id:!0}),u=P(C),f&&f.l(C),S=P(C),d&&d.l(C),C.forEach(k),this.h()},h(){document.title="Peer1",V(v,"for","use-video"),V(r,"type","checkbox"),V(r,"id","use-video")},m(s,E){I(s,e,E),I(s,t,E),c(t,n),c(n,l),c(n,_),g.m(n,null),c(t,b),c(t,p),c(t,a),c(t,v),c(t,B),c(t,r),r.checked=o[0],c(t,u),f&&f.m(t,null),c(t,S),d&&d.m(t,null),U||(H=A(r,"change",o[5]),U=!0)},p(s,[E]){D===(D=q(s))&&g?g.p(s,E):(g.d(1),g=D(s),g&&(g.c(),g.m(n,null))),E&1&&(r.checked=s[0]),s[2].connected?f&&(f.d(1),f=null):f||(f=G(),f.c(),f.m(t,S)),s[2].dataConn?d?d.p(s,E):(d=J(s),d.c(),d.m(t,null)):d&&(d.d(1),d=null)},i:M,o:M,d(s){s&&(k(e),k(t)),g.d(),f&&f.d(),d&&d.d(),U=!1,H()}}}function he(o,e,t){let n;R(o,x,a=>t(2,n=a));let l=!1,i=!1;async function _(){const a=await ee.connect();t(1,l=a)}de.subscribe(a=>{a&&console.log("got command",a)});const b=()=>_();function p(){i=this.checked,t(0,i)}const w=()=>{var a;return(a=n.dataConn)==null?void 0:a.send({message:"ping!",date:new Date})};return o.$$.update=()=>{o.$$.dirty&1&&(i&&navigator.mediaDevices.getUserMedia({video:!0}).then(a=>{x.update(v=>({...v,mediaStream:a}))}),i||x.update(a=>({...a,mediaStream:null})))},[i,l,n,_,b,p,w]}class ke extends X{constructor(e){super(),Y(this,e,he,pe,Q,{})}}export{ke as component,ge as universal};
