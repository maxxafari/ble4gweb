import{f as A,s as R,n as j,c as X}from"../chunks/scheduler.aa60952c.js";import{S as Y,i as Z,s as y,g as h,B as $,f as k,c as w,h as m,j as M,y as T,k as U,a as I,A as c,C as H,m as F,n as G,o as ee}from"../chunks/index.a7391ef6.js";import{d as O}from"../chunks/device.84554f9d.js";import{p as Q,e as te,c as ne,b as oe,a as le}from"../chunks/peers.c88dee28.js";import{d as ae,w as ie}from"../chunks/index.9adb9ad6.js";const se=!1,ce=!0,ge=Object.freeze(Object.defineProperty({__proto__:null,prerender:ce,ssr:se},Symbol.toStringTag,{value:"Module"})),z=async o=>{const e=A(x).peer;if(!e)throw new Error("Peer is null when calling p2");const t=e.connect(Q);t.once("open",()=>{oe(t,o)}),t.once("close",()=>{console.info("data connection closed calling p2 again..."),z(o)}),setTimeout(()=>{var n,a;console.info("checking if peer2 is connected: ",(n=t.peerConnection)==null?void 0:n.connectionState),["connecting","connected"].includes((a=t.peerConnection)==null?void 0:a.connectionState)||(t.removeAllListeners(),console.info("retrying connection to peer2"),z(o))},8e3)},re=async o=>{console.info("Creating new peer1"),await ne(le,o);const e=A(x).peer;if(!e)throw new Error("Peer is null when calling p2");e==null||e.on("error",t=>{t.type==="peer-unavailable"&&console.log("peer unavailable")}),e==null||e.once("open",()=>{z(o)})},x=ie(te,()=>(console.info("new subscription for peer1"),A(x).peer===null&&re(x),()=>{console.info("No subscription  peer1")}));x.subscribe(({peer:o,mediaStream:e,mediaConn:t})=>{if(e&&o&&!t){console.log("mediaStream changed");const n=o==null?void 0:o.call(Q,e);x.update(a=>({...a,mediaConn:n}))}else!e&&t&&(console.log("mediaStream cleared"),t.close(),x.update(n=>({...n,mediaConn:null})))});const de=ae(x,o=>o.lastCommand);function fe(o){let e,t="Connect BLE",n,a;return{c(){e=h("button"),e.textContent=t},l(i){e=m(i,"BUTTON",{"data-svelte-h":!0}),T(e)!=="svelte-p8uxjk"&&(e.textContent=t)},m(i,v){I(i,e,v),n||(a=H(e,"click",o[4]),n=!0)},p:j,d(i){i&&k(e),n=!1,a()}}}function ue(o){let e,t="Not connected";return{c(){e=h("p"),e.textContent=t},l(n){e=m(n,"P",{"data-svelte-h":!0}),T(e)!=="svelte-1cfn932"&&(e.textContent=t)},m(n,a){I(n,e,a)},p:j,d(n){n&&k(e)}}}function J(o){let e,t="<h4>Calling peer2...</h4>";return{c(){e=h("div"),e.innerHTML=t},l(n){e=m(n,"DIV",{"data-svelte-h":!0}),T(e)!=="svelte-1jdsk8a"&&(e.innerHTML=t)},m(n,a){I(n,e,a)},d(n){n&&k(e)}}}function K(o){let e,t,n="Connected to Peer2",a,i,v,b=o[2].dataConn?"true":"false",p,P,l,_="Send data",L,B;return{c(){e=h("div"),t=h("h4"),t.textContent=n,a=y(),i=h("p"),v=F("has dataConn: "),p=F(b),P=y(),l=h("button"),l.textContent=_},l(r){e=m(r,"DIV",{});var u=M(e);t=m(u,"H4",{"data-svelte-h":!0}),T(t)!=="svelte-1n8zg7s"&&(t.textContent=n),a=w(u),i=m(u,"P",{});var S=M(i);v=G(S,"has dataConn: "),p=G(S,b),S.forEach(k),P=w(u),l=m(u,"BUTTON",{"data-svelte-h":!0}),T(l)!=="svelte-eqb3bi"&&(l.textContent=_),u.forEach(k)},m(r,u){I(r,e,u),c(e,t),c(e,a),c(e,i),c(i,v),c(i,p),c(e,P),c(e,l),L||(B=H(l,"click",o[6]),L=!0)},p(r,u){u&4&&b!==(b=r[2].dataConn?"true":"false")&&ee(p,b)},d(r){r&&k(e),L=!1,B()}}}function pe(o){let e,t,n,a,i="BLE device",v,b,p,P="Caller (initiator)",l,_,L="Use video",B,r,u,S,N,q;function W(s,E){return s[1]?ue:fe}let D=W(o),g=D(o),f=!o[2].connected&&J(),d=o[2].dataConn&&K(o);return{c(){e=y(),t=h("div"),n=h("div"),a=h("p"),a.textContent=i,v=y(),g.c(),b=y(),p=h("p"),p.textContent=P,l=y(),_=h("label"),_.textContent=L,B=y(),r=h("input"),u=y(),f&&f.c(),S=y(),d&&d.c(),this.h()},l(s){$("svelte-czx9hh",document.head).forEach(k),e=w(s),t=m(s,"DIV",{});var C=M(t);n=m(C,"DIV",{});var V=M(n);a=m(V,"P",{"data-svelte-h":!0}),T(a)!=="svelte-r1r1cb"&&(a.textContent=i),v=w(V),g.l(V),V.forEach(k),b=w(C),p=m(C,"P",{"data-svelte-h":!0}),T(p)!=="svelte-1id8pt1"&&(p.textContent=P),l=w(C),_=m(C,"LABEL",{for:!0,"data-svelte-h":!0}),T(_)!=="svelte-eeyfdt"&&(_.textContent=L),B=w(C),r=m(C,"INPUT",{type:!0,id:!0}),u=w(C),f&&f.l(C),S=w(C),d&&d.l(C),C.forEach(k),this.h()},h(){document.title="Peer1",U(_,"for","use-video"),U(r,"type","checkbox"),U(r,"id","use-video")},m(s,E){I(s,e,E),I(s,t,E),c(t,n),c(n,a),c(n,v),g.m(n,null),c(t,b),c(t,p),c(t,l),c(t,_),c(t,B),c(t,r),r.checked=o[0],c(t,u),f&&f.m(t,null),c(t,S),d&&d.m(t,null),N||(q=H(r,"change",o[5]),N=!0)},p(s,[E]){D===(D=W(s))&&g?g.p(s,E):(g.d(1),g=D(s),g&&(g.c(),g.m(n,null))),E&1&&(r.checked=s[0]),s[2].connected?f&&(f.d(1),f=null):f||(f=J(),f.c(),f.m(t,S)),s[2].dataConn?d?d.p(s,E):(d=K(s),d.c(),d.m(t,null)):d&&(d.d(1),d=null)},i:j,o:j,d(s){s&&(k(e),k(t)),g.d(),f&&f.d(),d&&d.d(),N=!1,q()}}}function he(o,e,t){let n;X(o,x,l=>t(2,n=l));let a=!1,i=!1;async function v(){const l=await O.connect();t(1,a=l)}de.subscribe(l=>{if(l)switch(console.log("got command",l),a||console.warn("command not sent, BLE not connected"),l.key){case"L":O.leds.setVal(l.value?"11":"00");case"S":O.servo.setVal(l.value)}});const b=()=>v();function p(){i=this.checked,t(0,i)}const P=()=>{var l;return(l=n.dataConn)==null?void 0:l.send({message:"ping!",date:new Date})};return o.$$.update=()=>{o.$$.dirty&1&&(i&&navigator.mediaDevices.getUserMedia({video:!0}).then(l=>{x.update(_=>({..._,mediaStream:l}))}),i||x.update(l=>({...l,mediaStream:null})))},[i,a,n,v,b,p,P]}class ke extends Y{constructor(e){super(),Z(this,e,he,pe,R,{})}}export{ke as component,ge as universal};
