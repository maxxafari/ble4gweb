import{f as ee,s as te,n as N,c as ne,o as oe}from"../chunks/scheduler.396ab924.js";import{S as re,i as ae,g as h,h as v,j as P,f as g,a as W,s as C,z as A,c as $,k as M,A as f,C as Q,m as j,n as H,o as Y,r as E,B as le,u as L,v as R,d as z,t as U,w as B}from"../chunks/index.2cee157a.js";import{C as ie,H as ce,L as fe,p as de,b as ue}from"../chunks/utils.fa10bf7a.js";import{b as pe,a as me,S as he,C as ve}from"../chunks/Status.cd8930fb.js";import{p as se,e as ge,c as _e,a as Ce,b as $e}from"../chunks/peers.95a3d0bb.js";import{b as be}from"../chunks/statusStore.c6a4319c.js";import{w as Se}from"../chunks/index.7cfe3c3c.js";const we=!1,Te=!0,Oe=Object.freeze(Object.defineProperty({__proto__:null,prerender:Te,ssr:we},Symbol.toStringTag,{value:"Module"})),K=async a=>{const t=ee(w).peer;if(!t)throw new Error("Peer is null when calling p2");if(t.disconnected){console.warn("Disconnected from web-RTC server, reconnecting"),t.reconnect();return}const e=t.connect(se);e.once("open",()=>{console.info("Web-RTC call is open"),$e(e,a),be(e),pe(e),me(e)}),e.once("close",()=>{console.info("Web-RTC call closed calling peer2 again..."),e.removeAllListeners(),K(a)}),e.on("error",r=>{console.error("p1 dataConn error",{err:r})}),setTimeout(()=>{var r,o;console.info("checking if peer2 is connected: ",(r=e.peerConnection)==null?void 0:r.connectionState),["connecting","connected"].includes((o=e.peerConnection)==null?void 0:o.connectionState)||(e.removeAllListeners(),console.info("retrying connection to peer2"),K(a))},8e3)},ke=async a=>{console.info("Creating new peer1"),await _e(Ce,a);const t=ee(a).peer;if(!t)throw new Error("Peer is null when calling p2");t==null||t.on("error",e=>{e.type==="peer-unavailable"?console.log("webRTC peer not available",e):console.error("peerjs Peer error",{err:e})}),t==null||t.once("open",()=>{K(a)})},w=Se(ge("peer1"));w.subscribe(({peer:a,mediaStream:t,mediaConn:e})=>{if(t&&a&&!e){console.log("mediaStream added");const r=a==null?void 0:a.call(se,t);w.update(o=>({...o,mediaConn:r}))}else!t&&e&&(console.log("mediaStream cleared"),e.close(),w.update(r=>({...r,mediaConn:null})))});function ye(a){let t,e,r="Driver",o,n,l="Connect to driver",s,d;return{c(){t=h("div"),e=h("span"),e.textContent=r,o=C(),n=h("button"),n.textContent=l,this.h()},l(u){t=v(u,"DIV",{class:!0});var i=P(t);e=v(i,"SPAN",{"data-svelte-h":!0}),A(e)!=="svelte-fau2z0"&&(e.textContent=r),o=$(i),n=v(i,"BUTTON",{class:!0,"data-svelte-h":!0}),A(n)!=="svelte-1y263tm"&&(n.textContent=l),i.forEach(g),this.h()},h(){M(n,"class","svelte-l32fkz"),M(t,"class","connect svelte-l32fkz")},m(u,i){W(u,t,i),f(t,e),f(t,o),f(t,n),s||(d=Q(n,"click",a[3]),s=!0)},p:N,d(u){u&&g(t),s=!1,d()}}}function xe(a){let t,e,r,o=a[2].open?"游릭":"游댮",n,l,s,d,u=a[2].dataConn?"游릭":"游댮",i;return{c(){t=h("ul"),e=h("li"),r=j("Web-RTC server "),n=j(o),l=C(),s=h("li"),d=j("Driver "),i=j(u),this.h()},l(S){t=v(S,"UL",{class:!0});var _=P(t);e=v(_,"LI",{});var b=P(e);r=H(b,"Web-RTC server "),n=H(b,o),b.forEach(g),l=$(_),s=v(_,"LI",{});var T=P(s);d=H(T,"Driver "),i=H(T,u),T.forEach(g),_.forEach(g),this.h()},h(){M(t,"class","svelte-l32fkz")},m(S,_){W(S,t,_),f(t,e),f(e,r),f(e,n),f(t,l),f(t,s),f(s,d),f(s,i)},p(S,_){_&4&&o!==(o=S[2].open?"游릭":"游댮")&&Y(n,o),_&4&&u!==(u=S[2].dataConn?"游릭":"游댮")&&Y(i,u)},d(S){S&&g(t)}}}function De(a){let t;function e(n,l){return n[0]||n[1]?xe:ye}let r=e(a),o=r(a);return{c(){t=h("div"),o.c()},l(n){t=v(n,"DIV",{});var l=P(t);o.l(l),l.forEach(g)},m(n,l){W(n,t,l),o.m(t,null)},p(n,[l]){r===(r=e(n))&&o?o.p(n,l):(o.d(1),o=r(n),o&&(o.c(),o.m(t,null)))},i:N,o:N,d(n){n&&g(t),o.d()}}}function Pe(a,t,e){let r;ne(a,w,s=>e(2,r=s));let o=!1,n=!1;r.dataConn;function l(){e(0,o=!0),ke(w)}return oe(()=>{const s=setInterval(()=>{var d;r.peer?e(1,n=!r.peer.disconnected):e(1,n=!1),r.dataConn,(d=r.dataConn)==null||d.send("ping")},2e3);return()=>{clearInterval(s)}}),[o,n,r,l]}class Ie extends re{constructor(t){super(),ae(this,t,Pe,De,te,{})}}function Z(a){let t,e,r="Connected to Peer2",o,n,l="Send data",s,d;return{c(){t=h("div"),e=h("h4"),e.textContent=r,o=C(),n=h("button"),n.textContent=l},l(u){t=v(u,"DIV",{});var i=P(t);e=v(i,"H4",{"data-svelte-h":!0}),A(e)!=="svelte-1n8zg7s"&&(e.textContent=r),o=$(i),n=v(i,"BUTTON",{"data-svelte-h":!0}),A(n)!=="svelte-eqb3bi"&&(n.textContent=l),i.forEach(g)},m(u,i){W(u,t,i),f(t,e),f(t,o),f(t,n),s||(d=Q(n,"click",a[3]),s=!0)},p:N,d(u){u&&g(t),s=!1,d()}}}function Ee(a){let t,e,r,o="Open this page on vehicle device",n,l,s,d,u,i,S="Use video",_,b,T,O,k,q,y,F,x,G,D,V,J,X;l=new ie({}),d=new Ie({});let m=a[1].dataConn&&Z(a);return k=new he({props:{isSender:!0}}),y=new ve({}),x=new ce({}),D=new fe({}),{c(){t=C(),e=h("div"),r=h("h3"),r.textContent=o,n=C(),E(l.$$.fragment),s=C(),E(d.$$.fragment),u=C(),i=h("label"),i.textContent=S,_=C(),b=h("input"),T=C(),m&&m.c(),O=C(),E(k.$$.fragment),q=C(),E(y.$$.fragment),F=C(),E(x.$$.fragment),G=C(),E(D.$$.fragment),this.h()},l(c){le("svelte-czx9hh",document.head).forEach(g),t=$(c),e=v(c,"DIV",{});var p=P(e);r=v(p,"H3",{"data-svelte-h":!0}),A(r)!=="svelte-1f1lwve"&&(r.textContent=o),n=$(p),L(l.$$.fragment,p),s=$(p),L(d.$$.fragment,p),u=$(p),i=v(p,"LABEL",{for:!0,"data-svelte-h":!0}),A(i)!=="svelte-eeyfdt"&&(i.textContent=S),_=$(p),b=v(p,"INPUT",{type:!0,id:!0}),T=$(p),m&&m.l(p),O=$(p),L(k.$$.fragment,p),q=$(p),L(y.$$.fragment,p),F=$(p),L(x.$$.fragment,p),G=$(p),L(D.$$.fragment,p),p.forEach(g),this.h()},h(){document.title="Peer1",M(i,"for","use-video"),M(b,"type","checkbox"),M(b,"id","use-video")},m(c,I){W(c,t,I),W(c,e,I),f(e,r),f(e,n),R(l,e,null),f(e,s),R(d,e,null),f(e,u),f(e,i),f(e,_),f(e,b),b.checked=a[0],f(e,T),m&&m.m(e,null),f(e,O),R(k,e,null),f(e,q),R(y,e,null),f(e,F),R(x,e,null),f(e,G),R(D,e,null),V=!0,J||(X=Q(b,"change",a[2]),J=!0)},p(c,[I]){I&1&&(b.checked=c[0]),c[1].dataConn?m?m.p(c,I):(m=Z(c),m.c(),m.m(e,O)):m&&(m.d(1),m=null)},i(c){V||(z(l.$$.fragment,c),z(d.$$.fragment,c),z(k.$$.fragment,c),z(y.$$.fragment,c),z(x.$$.fragment,c),z(D.$$.fragment,c),V=!0)},o(c){U(l.$$.fragment,c),U(d.$$.fragment,c),U(k.$$.fragment,c),U(y.$$.fragment,c),U(x.$$.fragment,c),U(D.$$.fragment,c),V=!1},d(c){c&&(g(t),g(e)),B(l),B(d),m&&m.d(),B(k),B(y),B(x),B(D),J=!1,X()}}}function Le(a,t,e){let r;ne(a,w,s=>e(1,r=s));let o=!1;oe(()=>(de(),ue()));function n(){o=this.checked,e(0,o)}const l=()=>{var s;return(s=r.dataConn)==null?void 0:s.send({message:"ping!",date:new Date})};return a.$$.update=()=>{a.$$.dirty&1&&(o&&navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(s=>{w.update(d=>({...d,mediaStream:s}))}).catch(s=>{e(0,o=!1),console.log("getUserMedia error",s)}),o||w.update(s=>({...s,mediaStream:null})))},[o,r,n,l]}class Ve extends re{constructor(t){super(),ae(this,t,Le,Ee,te,{})}}export{Ve as component,Oe as universal};
