import{f as A,s as R,n as j,c as X}from"../chunks/scheduler.aa60952c.js";import{S as Y,i as Z,s as P,g as _,B as $,f as x,c as w,h as v,j as M,y as L,k as O,a as B,A as c,C as H,m as F,n as G,o as ee}from"../chunks/index.a7391ef6.js";import{d as V}from"../chunks/device.84554f9d.js";import{p as Q,e as te,c as ne,a as oe,b as le}from"../chunks/peers.8d3438e1.js";import{d as ae,w as ie}from"../chunks/index.9adb9ad6.js";const se=!1,ce=!0,ge=Object.freeze(Object.defineProperty({__proto__:null,prerender:ce,ssr:se},Symbol.toStringTag,{value:"Module"})),z=async o=>{const e=A(y).peer;if(!e)throw new Error("Peer is null when calling p2");const t=e.connect(Q);t.once("open",()=>{le(t,o)}),t.once("close",()=>{console.info("data connection closed calling p2 again..."),z(o)}),setTimeout(()=>{var n,a;console.info("checking if peer2 is connected: ",(n=t.peerConnection)==null?void 0:n.connectionState),["connecting","connected"].includes((a=t.peerConnection)==null?void 0:a.connectionState)||(t.removeAllListeners(),console.info("retrying connection to peer2"),z(o))},8e3)},re=async o=>{console.info("Creating new peer1"),await ne(oe,o);const e=A(y).peer;if(!e)throw new Error("Peer is null when calling p2");e==null||e.on("error",t=>{t.type==="peer-unavailable"&&console.log("peer unavailable")}),e==null||e.once("open",()=>{z(o)})},y=ie(te,()=>(console.info("new subscription for peer1"),A(y).peer===null&&re(y),()=>{console.info("No subscription  peer1")}));y.subscribe(({peer:o,mediaStream:e,mediaConn:t})=>{if(e&&o&&!t){console.log("mediaStream changed");const n=o==null?void 0:o.call(Q,e);y.update(a=>({...a,mediaConn:n}))}else!e&&t&&(console.log("mediaStream cleared"),t.close(),y.update(n=>({...n,mediaConn:null})))});const de=ae(y,o=>o.lastCommand);function fe(o){let e,t="Connect BLE",n,a;return{c(){e=_("button"),e.textContent=t},l(i){e=v(i,"BUTTON",{"data-svelte-h":!0}),L(e)!=="svelte-p8uxjk"&&(e.textContent=t)},m(i,C){B(i,e,C),n||(a=H(e,"click",o[4]),n=!0)},p:j,d(i){i&&x(e),n=!1,a()}}}function ue(o){let e,t="Not connected";return{c(){e=_("p"),e.textContent=t},l(n){e=v(n,"P",{"data-svelte-h":!0}),L(e)!=="svelte-1cfn932"&&(e.textContent=t)},m(n,a){B(n,e,a)},p:j,d(n){n&&x(e)}}}function J(o){let e,t="<h4>Calling peer2...</h4>";return{c(){e=_("div"),e.innerHTML=t},l(n){e=v(n,"DIV",{"data-svelte-h":!0}),L(e)!=="svelte-1jdsk8a"&&(e.innerHTML=t)},m(n,a){B(n,e,a)},d(n){n&&x(e)}}}function K(o){let e,t,n="Connected to Peer2",a,i,C,b=o[2].dataConn?"true":"false",m,E,h,l="Send data",u,S;return{c(){e=_("div"),t=_("h4"),t.textContent=n,a=P(),i=_("p"),C=F("has dataConn: "),m=F(b),E=P(),h=_("button"),h.textContent=l},l(r){e=v(r,"DIV",{});var p=M(e);t=v(p,"H4",{"data-svelte-h":!0}),L(t)!=="svelte-1n8zg7s"&&(t.textContent=n),a=w(p),i=v(p,"P",{});var T=M(i);C=G(T,"has dataConn: "),m=G(T,b),T.forEach(x),E=w(p),h=v(p,"BUTTON",{"data-svelte-h":!0}),L(h)!=="svelte-eqb3bi"&&(h.textContent=l),p.forEach(x)},m(r,p){B(r,e,p),c(e,t),c(e,a),c(e,i),c(i,C),c(i,m),c(e,E),c(e,h),u||(S=H(h,"click",o[6]),u=!0)},p(r,p){p&4&&b!==(b=r[2].dataConn?"true":"false")&&ee(m,b)},d(r){r&&x(e),u=!1,S()}}}function pe(o){let e,t,n,a,i="BLE device",C,b,m,E="Caller (initiator)",h,l,u="Use video",S,r,p,T,U,q;function W(s,I){return s[1]?ue:fe}let D=W(o),k=D(o),f=!o[2].connected&&J(),d=o[2].dataConn&&K(o);return{c(){e=P(),t=_("div"),n=_("div"),a=_("p"),a.textContent=i,C=P(),k.c(),b=P(),m=_("p"),m.textContent=E,h=P(),l=_("label"),l.textContent=u,S=P(),r=_("input"),p=P(),f&&f.c(),T=P(),d&&d.c(),this.h()},l(s){$("svelte-czx9hh",document.head).forEach(x),e=w(s),t=v(s,"DIV",{});var g=M(t);n=v(g,"DIV",{});var N=M(n);a=v(N,"P",{"data-svelte-h":!0}),L(a)!=="svelte-r1r1cb"&&(a.textContent=i),C=w(N),k.l(N),N.forEach(x),b=w(g),m=v(g,"P",{"data-svelte-h":!0}),L(m)!=="svelte-1id8pt1"&&(m.textContent=E),h=w(g),l=v(g,"LABEL",{for:!0,"data-svelte-h":!0}),L(l)!=="svelte-eeyfdt"&&(l.textContent=u),S=w(g),r=v(g,"INPUT",{type:!0,id:!0}),p=w(g),f&&f.l(g),T=w(g),d&&d.l(g),g.forEach(x),this.h()},h(){document.title="Peer1",O(l,"for","use-video"),O(r,"type","checkbox"),O(r,"id","use-video")},m(s,I){B(s,e,I),B(s,t,I),c(t,n),c(n,a),c(n,C),k.m(n,null),c(t,b),c(t,m),c(t,h),c(t,l),c(t,S),c(t,r),r.checked=o[0],c(t,p),f&&f.m(t,null),c(t,T),d&&d.m(t,null),U||(q=H(r,"change",o[5]),U=!0)},p(s,[I]){D===(D=W(s))&&k?k.p(s,I):(k.d(1),k=D(s),k&&(k.c(),k.m(n,null))),I&1&&(r.checked=s[0]),s[2].connected?f&&(f.d(1),f=null):f||(f=J(),f.c(),f.m(t,T)),s[2].dataConn?d?d.p(s,I):(d=K(s),d.c(),d.m(t,null)):d&&(d.d(1),d=null)},i:j,o:j,d(s){s&&(x(e),x(t)),k.d(),f&&f.d(),d&&d.d(),U=!1,q()}}}function me(o,e,t){let n;X(o,y,l=>t(2,n=l));let a=!1,i=!1,C=(l,u)=>{console.log("onCommand not defined",{service:l,value:u})};async function b(){const l=await V.connect();t(1,a=l),C=(u,S)=>{console.info("got command",S),u in V&&(u==="leds"?V.leds.setVal(S.toString()):u==="servo"&&V.servo.setVal(parseInt(S.toString())))}}de.subscribe(l=>{l.serviceName&&C(l.serviceName,l.value)});const m=()=>b();function E(){i=this.checked,t(0,i)}const h=()=>{var l;return(l=n.dataConn)==null?void 0:l.send({message:"ping!",date:new Date})};return o.$$.update=()=>{o.$$.dirty&1&&(i&&navigator.mediaDevices.getUserMedia({video:!0}).then(l=>{y.update(u=>({...u,mediaStream:l}))}),i||y.update(l=>({...l,mediaStream:null})))},[i,a,n,b,m,E,h]}class ke extends Y{constructor(e){super(),Z(this,e,me,pe,R,{})}}export{ke as component,ge as universal};
