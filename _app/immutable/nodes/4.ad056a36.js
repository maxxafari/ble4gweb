import{f as A,s as K,n as M,c as Q}from"../chunks/scheduler.aa60952c.js";import{S as Y,i as Z,s as x,g as h,B as $,f as k,c as y,h as v,j as N,y as B,k as O,a as I,A as c,C as H,m as R,n as W,o as ee}from"../chunks/index.1eddc4da.js";import{d as j}from"../chunks/device.95773448.js";import{p as J,e as te,c as ne,b as oe,a as le}from"../chunks/peers.d8a03dfc.js";import{d as ae,w as ie}from"../chunks/index.9adb9ad6.js";const se=!1,ce=!0,ge=Object.freeze(Object.defineProperty({__proto__:null,prerender:ce,ssr:se},Symbol.toStringTag,{value:"Module"})),z=async o=>{const e=A(w).peer;if(!e)throw new Error("Peer is null when calling p2");const t=e.connect(J);t.once("open",()=>{oe(t,o)}),t.once("close",()=>{console.info("data connection closed calling p2 again..."),z(o)}),setTimeout(()=>{var n,a;console.info("checking if peer2 is connected: ",(n=t.peerConnection)==null?void 0:n.connectionState),["connecting","connected"].includes((a=t.peerConnection)==null?void 0:a.connectionState)||(t.removeAllListeners(),console.info("retrying connection to peer2"),z(o))},8e3)},re=async o=>{console.info("Creating new peer1"),await ne(le,o);const e=A(w).peer;if(!e)throw new Error("Peer is null when calling p2");e==null||e.on("error",t=>{t.type==="peer-unavailable"&&console.log("peer unavailable")}),e==null||e.once("open",()=>{z(o)})},w=ie(te,()=>(console.info("new subscription for peer1"),A(w).peer===null&&re(w),()=>{console.info("No subscription  peer1")}));w.subscribe(({peer:o,mediaStream:e,mediaConn:t})=>{if(e&&o&&!t){console.log("mediaStream changed");const n=o==null?void 0:o.call(J,e);w.update(a=>({...a,mediaConn:n}))}else!e&&t&&(console.log("mediaStream cleared"),t.close(),w.update(n=>({...n,mediaConn:null})))});const de=ae(w,o=>o.lastCommand);function ue(o){let e,t="Connect BLE",n,a;return{c(){e=h("button"),e.textContent=t},l(i){e=v(i,"BUTTON",{"data-svelte-h":!0}),B(e)!=="svelte-p8uxjk"&&(e.textContent=t)},m(i,_){I(i,e,_),n||(a=H(e,"click",o[4]),n=!0)},p:M,d(i){i&&k(e),n=!1,a()}}}function fe(o){let e,t="Not connected";return{c(){e=h("p"),e.textContent=t},l(n){e=v(n,"P",{"data-svelte-h":!0}),B(e)!=="svelte-1cfn932"&&(e.textContent=t)},m(n,a){I(n,e,a)},p:M,d(n){n&&k(e)}}}function F(o){let e,t="<h4>Calling peer2...</h4>";return{c(){e=h("div"),e.innerHTML=t},l(n){e=v(n,"DIV",{"data-svelte-h":!0}),B(e)!=="svelte-1jdsk8a"&&(e.innerHTML=t)},m(n,a){I(n,e,a)},d(n){n&&k(e)}}}function G(o){let e,t,n="Connected to Peer2",a,i,_,b=o[2].dataConn?"true":"false",m,P,l,f="Send data",S,E;return{c(){e=h("div"),t=h("h4"),t.textContent=n,a=x(),i=h("p"),_=R("has dataConn: "),m=R(b),P=x(),l=h("button"),l.textContent=f},l(r){e=v(r,"DIV",{});var p=N(e);t=v(p,"H4",{"data-svelte-h":!0}),B(t)!=="svelte-1n8zg7s"&&(t.textContent=n),a=y(p),i=v(p,"P",{});var T=N(i);_=W(T,"has dataConn: "),m=W(T,b),T.forEach(k),P=y(p),l=v(p,"BUTTON",{"data-svelte-h":!0}),B(l)!=="svelte-eqb3bi"&&(l.textContent=f),p.forEach(k)},m(r,p){I(r,e,p),c(e,t),c(e,a),c(e,i),c(i,_),c(i,m),c(e,P),c(e,l),S||(E=H(l,"click",o[6]),S=!0)},p(r,p){p&4&&b!==(b=r[2].dataConn?"true":"false")&&ee(m,b)},d(r){r&&k(e),S=!1,E()}}}function pe(o){let e,t,n,a,i="BLE device",_,b,m,P="Caller (initiator)",l,f,S="Use video",E,r,p,T,U,q;function X(s,L){return s[1]?fe:ue}let V=X(o),g=V(o),u=!o[2].connected&&F(),d=o[2].dataConn&&G(o);return{c(){e=x(),t=h("div"),n=h("div"),a=h("p"),a.textContent=i,_=x(),g.c(),b=x(),m=h("p"),m.textContent=P,l=x(),f=h("label"),f.textContent=S,E=x(),r=h("input"),p=x(),u&&u.c(),T=x(),d&&d.c(),this.h()},l(s){$("svelte-czx9hh",document.head).forEach(k),e=y(s),t=v(s,"DIV",{});var C=N(t);n=v(C,"DIV",{});var D=N(n);a=v(D,"P",{"data-svelte-h":!0}),B(a)!=="svelte-r1r1cb"&&(a.textContent=i),_=y(D),g.l(D),D.forEach(k),b=y(C),m=v(C,"P",{"data-svelte-h":!0}),B(m)!=="svelte-1id8pt1"&&(m.textContent=P),l=y(C),f=v(C,"LABEL",{for:!0,"data-svelte-h":!0}),B(f)!=="svelte-eeyfdt"&&(f.textContent=S),E=y(C),r=v(C,"INPUT",{type:!0,id:!0}),p=y(C),u&&u.l(C),T=y(C),d&&d.l(C),C.forEach(k),this.h()},h(){document.title="Peer1",O(f,"for","use-video"),O(r,"type","checkbox"),O(r,"id","use-video")},m(s,L){I(s,e,L),I(s,t,L),c(t,n),c(n,a),c(n,_),g.m(n,null),c(t,b),c(t,m),c(t,l),c(t,f),c(t,E),c(t,r),r.checked=o[0],c(t,p),u&&u.m(t,null),c(t,T),d&&d.m(t,null),U||(q=H(r,"change",o[5]),U=!0)},p(s,[L]){V===(V=X(s))&&g?g.p(s,L):(g.d(1),g=V(s),g&&(g.c(),g.m(n,null))),L&1&&(r.checked=s[0]),s[2].connected?u&&(u.d(1),u=null):u||(u=F(),u.c(),u.m(t,T)),s[2].dataConn?d?d.p(s,L):(d=G(s),d.c(),d.m(t,null)):d&&(d.d(1),d=null)},i:M,o:M,d(s){s&&(k(e),k(t)),g.d(),u&&u.d(),d&&d.d(),U=!1,q()}}}function me(o,e,t){let n;Q(o,w,l=>t(2,n=l));let a=!1,i=!1;async function _(){const l=await j.connect();t(1,a=l)}de.subscribe(l=>{if(l)switch(console.log("got command",l),a||console.warn("command not sent, BLE not connected"),l.key){case"X":{const{gear:f,direction:S}=l.value,E=new TextEncoder().encode("X"+f+S);j.leds.setValRaw(E.buffer);return}case"L":{j.leds.setVal(l.value?"11":"00");return}case"S":{j.servo.setVal(l.value);return}default:{console.warn("unknown command",l);return}}});const b=()=>_();function m(){i=this.checked,t(0,i)}const P=()=>{var l;return(l=n.dataConn)==null?void 0:l.send({message:"ping!",date:new Date})};return o.$$.update=()=>{o.$$.dirty&1&&(i&&navigator.mediaDevices.getUserMedia({video:!0}).then(l=>{w.update(f=>({...f,mediaStream:l}))}),i||w.update(l=>({...l,mediaStream:null})))},[i,a,n,_,b,m,P]}class ke extends Y{constructor(e){super(),Z(this,e,me,pe,K,{})}}export{ke as component,ge as universal};
