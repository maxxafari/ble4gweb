import{f as q,s as $,n as V,c as ee}from"../chunks/scheduler.aa60952c.js";import{S as te,i as ne,s as w,g as m,B as oe,f as k,c as P,h,j as M,y as T,k as A,a as B,A as s,C as z,m as W,n as F,o as ae}from"../chunks/index.bdada946.js";import{c as H,a as re}from"../chunks/BLEServiceBuilder.6eed7d52.js";import{p as K,e as ce,c as le,b as se,a as ie}from"../chunks/peers.e0652c7d.js";import{d as de,w as fe}from"../chunks/index.9adb9ad6.js";const ue=!1,pe=!0,Se=Object.freeze(Object.defineProperty({__proto__:null,prerender:pe,ssr:ue},Symbol.toStringTag,{value:"Module"})),Q=H({name:"Battery",serviceId:"battery_service",characteristicId:"battery_level",isNotifiable:!0,readParser:n=>n.getUint8(0).toString()}),Y=H({name:"Leds",serviceId:"a3941db0-a97c-4cf1-943f-a25ff9ba40cd",characteristicId:"5b8c0ab6-a058-4684-b2b6-4a0a692e2d45",isNotifiable:!1,readParser:n=>(console.log("dataView leds",n),n.getInt8(0)+""+n.getInt8(1)),setParser:n=>{if(typeof n=="string"){const[e,t]=n.split("").map(o=>parseInt(o));return new Uint8Array([e,t])}else return new TextEncoder().encode("X"+n.gear+n.direction).buffer}}),Z=H({name:"Servo",serviceId:"847a27cd-ccf0-4f7e-8cb4-d5fe53df2d60",characteristicId:"7c1b818b-dff0-4514-8bcf-f0ad8c79fad9",isNotifiable:!1,readParser:n=>n.getUint8(0),setParser:(n,e)=>{const t=[n,e||90];return new Uint8Array(t).buffer}}),ve=re([Y,Z,Q]),N={...ve,leds:Y,servo:Z,battery:Q},O=async n=>{const e=q(y).peer;if(!e)throw new Error("Peer is null when calling p2");const t=e.connect(K);t.once("open",()=>{se(t,n)}),t.once("close",()=>{console.info("data connection closed calling p2 again..."),O(n)}),setTimeout(()=>{var o,r;console.info("checking if peer2 is connected: ",(o=t.peerConnection)==null?void 0:o.connectionState),["connecting","connected"].includes((r=t.peerConnection)==null?void 0:r.connectionState)||(t.removeAllListeners(),console.info("retrying connection to peer2"),O(n))},8e3)},me=async n=>{console.info("Creating new peer1"),await le(ie,n);const e=q(y).peer;if(!e)throw new Error("Peer is null when calling p2");e==null||e.on("error",t=>{t.type==="peer-unavailable"&&console.log("peer unavailable")}),e==null||e.once("open",()=>{O(n)})},y=fe(ce,()=>(console.info("new subscription for peer1"),q(y).peer===null&&me(y),()=>{console.info("No subscription  peer1")}));y.subscribe(({peer:n,mediaStream:e,mediaConn:t})=>{if(e&&n&&!t){console.log("mediaStream changed");const o=n==null?void 0:n.call(K,e);y.update(r=>({...r,mediaConn:o}))}else!e&&t&&(console.log("mediaStream cleared"),t.close(),y.update(o=>({...o,mediaConn:null})))});const he=de(y,n=>n.lastCommand);function be(n){let e,t="Connect BLE",o,r;return{c(){e=m("button"),e.textContent=t},l(c){e=h(c,"BUTTON",{"data-svelte-h":!0}),T(e)!=="svelte-p8uxjk"&&(e.textContent=t)},m(c,b){B(c,e,b),o||(r=z(e,"click",n[4]),o=!0)},p:V,d(c){c&&k(e),o=!1,r()}}}function _e(n){let e,t="Not connected";return{c(){e=m("p"),e.textContent=t},l(o){e=h(o,"P",{"data-svelte-h":!0}),T(e)!=="svelte-1cfn932"&&(e.textContent=t)},m(o,r){B(o,e,r)},p:V,d(o){o&&k(e)}}}function G(n){let e,t="<h4>Calling peer2...</h4>";return{c(){e=m("div"),e.innerHTML=t},l(o){e=h(o,"DIV",{"data-svelte-h":!0}),T(e)!=="svelte-1jdsk8a"&&(e.innerHTML=t)},m(o,r){B(o,e,r)},d(o){o&&k(e)}}}function J(n){let e,t,o="Connected to Peer2",r,c,b,C=n[2].dataConn?"true":"false",v,x,a,u="Send data",S,I;return{c(){e=m("div"),t=m("h4"),t.textContent=o,r=w(),c=m("p"),b=W("has dataConn: "),v=W(C),x=w(),a=m("button"),a.textContent=u},l(i){e=h(i,"DIV",{});var p=M(e);t=h(p,"H4",{"data-svelte-h":!0}),T(t)!=="svelte-1n8zg7s"&&(t.textContent=o),r=P(p),c=h(p,"P",{});var E=M(c);b=F(E,"has dataConn: "),v=F(E,C),E.forEach(k),x=P(p),a=h(p,"BUTTON",{"data-svelte-h":!0}),T(a)!=="svelte-eqb3bi"&&(a.textContent=u),p.forEach(k)},m(i,p){B(i,e,p),s(e,t),s(e,r),s(e,c),s(c,b),s(c,v),s(e,x),s(e,a),S||(I=z(a,"click",n[6]),S=!0)},p(i,p){p&4&&C!==(C=i[2].dataConn?"true":"false")&&ae(v,C)},d(i){i&&k(e),S=!1,I()}}}function Ce(n){let e,t,o,r,c="BLE device",b,C,v,x="Caller (initiator)",a,u,S="Use video",I,i,p,E,j,X;function R(l,L){return l[1]?_e:be}let U=R(n),g=U(n),f=!n[2].connected&&G(),d=n[2].dataConn&&J(n);return{c(){e=w(),t=m("div"),o=m("div"),r=m("p"),r.textContent=c,b=w(),g.c(),C=w(),v=m("p"),v.textContent=x,a=w(),u=m("label"),u.textContent=S,I=w(),i=m("input"),p=w(),f&&f.c(),E=w(),d&&d.c(),this.h()},l(l){oe("svelte-czx9hh",document.head).forEach(k),e=P(l),t=h(l,"DIV",{});var _=M(t);o=h(_,"DIV",{});var D=M(o);r=h(D,"P",{"data-svelte-h":!0}),T(r)!=="svelte-r1r1cb"&&(r.textContent=c),b=P(D),g.l(D),D.forEach(k),C=P(_),v=h(_,"P",{"data-svelte-h":!0}),T(v)!=="svelte-1id8pt1"&&(v.textContent=x),a=P(_),u=h(_,"LABEL",{for:!0,"data-svelte-h":!0}),T(u)!=="svelte-eeyfdt"&&(u.textContent=S),I=P(_),i=h(_,"INPUT",{type:!0,id:!0}),p=P(_),f&&f.l(_),E=P(_),d&&d.l(_),_.forEach(k),this.h()},h(){document.title="Peer1",A(u,"for","use-video"),A(i,"type","checkbox"),A(i,"id","use-video")},m(l,L){B(l,e,L),B(l,t,L),s(t,o),s(o,r),s(o,b),g.m(o,null),s(t,C),s(t,v),s(t,a),s(t,u),s(t,I),s(t,i),i.checked=n[0],s(t,p),f&&f.m(t,null),s(t,E),d&&d.m(t,null),j||(X=z(i,"change",n[5]),j=!0)},p(l,[L]){U===(U=R(l))&&g?g.p(l,L):(g.d(1),g=U(l),g&&(g.c(),g.m(o,null))),L&1&&(i.checked=l[0]),l[2].connected?f&&(f.d(1),f=null):f||(f=G(),f.c(),f.m(t,E)),l[2].dataConn?d?d.p(l,L):(d=J(l),d.c(),d.m(t,null)):d&&(d.d(1),d=null)},i:V,o:V,d(l){l&&(k(e),k(t)),g.d(),f&&f.d(),d&&d.d(),j=!1,X()}}}function ge(n,e,t){let o;ee(n,y,a=>t(2,o=a));let r=!1,c=!0;async function b(){const a=await N.connect();t(1,r=a)}navigator.wakeLock.request("screen").then(a=>{}).catch(a=>{console.log("wakeLock error",a)}),he.subscribe(a=>{if(a)switch(console.log("got command",a),r||console.warn("command not sent, BLE not connected"),a.key){case"X":{const{gear:u,direction:S}=a.value,I=new TextEncoder().encode("X"+u+S);N.leds.setValRaw(I.buffer);return}case"L":{N.leds.setVal(a.value?"11":"00");return}case"S":{N.servo.setVal(a.value);return}default:{console.warn("unknown command",a);return}}});const C=()=>b();function v(){c=this.checked,t(0,c)}const x=()=>{var a;return(a=o.dataConn)==null?void 0:a.send({message:"ping!",date:new Date})};return n.$$.update=()=>{n.$$.dirty&1&&(c&&navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(a=>{y.update(u=>({...u,mediaStream:a}))}),c||y.update(a=>({...a,mediaStream:null})))},[c,r,o,b,C,v,x]}class Ie extends te{constructor(e){super(),ne(this,e,ge,Ce,$,{})}}export{Ie as component,Se as universal};
