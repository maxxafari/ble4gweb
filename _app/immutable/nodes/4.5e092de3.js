import{f as X,s as te,c as G,n as Z}from"../chunks/scheduler.52935eb4.js";import{S as ne,i as oe,s as w,g as S,r as ae,B as le,f as x,c as P,h as k,j as H,z as M,u as re,k as $,a as N,A as i,v as ie,C as F,d as se,t as ce,w as de,m as q,n as A,o as R}from"../chunks/index.573d0439.js";import{p as ee,e as ue,c as fe,b as pe,a as me,d as _e,S as he,s as J,f as K}from"../chunks/peers.f3213fe5.js";import{b as ve}from"../chunks/statusStore.7b483e2b.js";import{w as ge}from"../chunks/index.c5ad5140.js";const Ce=!1,be=!0,De=Object.freeze(Object.defineProperty({__proto__:null,prerender:be,ssr:Ce},Symbol.toStringTag,{value:"Module"})),W=async o=>{const e=X(D).peer;if(!e)throw new Error("Peer is null when calling p2");const t=e.connect(ee);t.once("open",()=>{pe(t,o),ve(t),me(t)}),t.once("close",()=>{console.info("data connection closed calling p2 again..."),W(o)}),setTimeout(()=>{var n,l;console.info("checking if peer2 is connected: ",(n=t.peerConnection)==null?void 0:n.connectionState),["connecting","connected"].includes((l=t.peerConnection)==null?void 0:l.connectionState)||(t.removeAllListeners(),console.info("retrying connection to peer2"),W(o))},8e3)},Se=async o=>{console.info("Creating new peer1"),await fe(_e,o);const e=X(o).peer;if(!e)throw new Error("Peer is null when calling p2");e==null||e.on("error",t=>{t.type==="peer-unavailable"&&console.log("peer unavailable")}),e==null||e.once("open",()=>{W(o)})},D=ge(ue("peer1"),()=>(console.info("new subscription for peer1"),X(D).peer===null&&Se(D),()=>{console.info("No subscription  peer1")}));D.subscribe(({peer:o,mediaStream:e,mediaConn:t})=>{if(e&&o&&!t){console.log("mediaStream changed");const n=o==null?void 0:o.call(ee,e);D.update(l=>({...l,mediaConn:n}))}else!e&&t&&(console.log("mediaStream cleared"),t.close(),D.update(n=>({...n,mediaConn:null})))});function ke(o){let e,t="Connect BLE",n,l;return{c(){e=S("button"),e.textContent=t},l(r){e=k(r,"BUTTON",{"data-svelte-h":!0}),M(e)!=="svelte-p8uxjk"&&(e.textContent=t)},m(r,c){N(r,e,c),n||(l=F(e,"click",o[5]),n=!0)},p:Z,d(r){r&&x(e),n=!1,l()}}}function we(o){let e,t="Not connected";return{c(){e=S("p"),e.textContent=t},l(n){e=k(n,"P",{"data-svelte-h":!0}),M(e)!=="svelte-1cfn932"&&(e.textContent=t)},m(n,l){N(n,e,l)},p:Z,d(n){n&&x(e)}}}function Q(o){let e,t="<h4>Calling peer2...</h4>";return{c(){e=S("div"),e.innerHTML=t},l(n){e=k(n,"DIV",{"data-svelte-h":!0}),M(e)!=="svelte-1jdsk8a"&&(e.innerHTML=t)},m(n,l){N(n,e,l)},d(n){n&&x(e)}}}function Y(o){let e,t,n="Connected to Peer2",l,r,c,g=o[3].dir+"",_,I,y=o[3].gear+"",h,a,C=o[3].speed+"",u,B,f,V="Send data",E,j;return{c(){e=S("div"),t=S("h4"),t.textContent=n,l=w(),r=S("p"),c=q("steering: "),_=q(g),I=w(),h=q(y),a=w(),u=q(C),B=w(),f=S("button"),f.textContent=V},l(b){e=k(b,"DIV",{});var p=H(e);t=k(p,"H4",{"data-svelte-h":!0}),M(t)!=="svelte-1n8zg7s"&&(t.textContent=n),l=P(p),r=k(p,"P",{});var L=H(r);c=A(L,"steering: "),_=A(L,g),I=P(L),h=A(L,y),a=P(L),u=A(L,C),L.forEach(x),B=P(p),f=k(p,"BUTTON",{"data-svelte-h":!0}),M(f)!=="svelte-eqb3bi"&&(f.textContent=V),p.forEach(x)},m(b,p){N(b,e,p),i(e,t),i(e,l),i(e,r),i(r,c),i(r,_),i(r,I),i(r,h),i(r,a),i(r,u),i(e,B),i(e,f),E||(j=F(f,"click",o[7]),E=!0)},p(b,p){p&8&&g!==(g=b[3].dir+"")&&R(_,g),p&8&&y!==(y=b[3].gear+"")&&R(h,y),p&8&&C!==(C=b[3].speed+"")&&R(u,C)},d(b){b&&x(e),E=!1,j()}}}function Pe(o){let e,t,n,l,r="BLE device",c,g,_,I="Caller (initiator)",y,h,a="Use video",C,u,B,f,V,E,j,b,p;function L(s,U){return s[1]?we:ke}let z=L(o),T=z(o),m=!o[2].dataConn&&Q(),d=o[2].dataConn&&Y(o);return E=new he({props:{isSender:!0}}),{c(){e=w(),t=S("div"),n=S("div"),l=S("p"),l.textContent=r,c=w(),T.c(),g=w(),_=S("p"),_.textContent=I,y=w(),h=S("label"),h.textContent=a,C=w(),u=S("input"),B=w(),m&&m.c(),f=w(),d&&d.c(),V=w(),ae(E.$$.fragment),this.h()},l(s){le("svelte-czx9hh",document.head).forEach(x),e=P(s),t=k(s,"DIV",{});var v=H(t);n=k(v,"DIV",{});var O=H(n);l=k(O,"P",{"data-svelte-h":!0}),M(l)!=="svelte-r1r1cb"&&(l.textContent=r),c=P(O),T.l(O),O.forEach(x),g=P(v),_=k(v,"P",{"data-svelte-h":!0}),M(_)!=="svelte-1id8pt1"&&(_.textContent=I),y=P(v),h=k(v,"LABEL",{for:!0,"data-svelte-h":!0}),M(h)!=="svelte-eeyfdt"&&(h.textContent=a),C=P(v),u=k(v,"INPUT",{type:!0,id:!0}),B=P(v),m&&m.l(v),f=P(v),d&&d.l(v),V=P(v),re(E.$$.fragment,v),v.forEach(x),this.h()},h(){document.title="Peer1",$(h,"for","use-video"),$(u,"type","checkbox"),$(u,"id","use-video")},m(s,U){N(s,e,U),N(s,t,U),i(t,n),i(n,l),i(n,c),T.m(n,null),i(t,g),i(t,_),i(t,y),i(t,h),i(t,C),i(t,u),u.checked=o[0],i(t,B),m&&m.m(t,null),i(t,f),d&&d.m(t,null),i(t,V),ie(E,t,null),j=!0,b||(p=F(u,"change",o[6]),b=!0)},p(s,[U]){z===(z=L(s))&&T?T.p(s,U):(T.d(1),T=z(s),T&&(T.c(),T.m(n,null))),U&1&&(u.checked=s[0]),s[2].dataConn?m&&(m.d(1),m=null):m||(m=Q(),m.c(),m.m(t,f)),s[2].dataConn?d?d.p(s,U):(d=Y(s),d.c(),d.m(t,V)):d&&(d.d(1),d=null)},i(s){j||(se(E.$$.fragment,s),j=!0)},o(s){ce(E.$$.fragment,s),j=!1},d(s){s&&(x(e),x(t)),T.d(),m&&m.d(),d&&d.d(),de(E),b=!1,p()}}}function ye(o,e,t){let n,l;G(o,D,a=>t(2,n=a)),G(o,J,a=>t(3,l=a));let r=!1,c=!0,g;async function _(){const a=await K.connect();t(1,r=a)}navigator.wakeLock.request("screen").then(a=>{}).catch(a=>{console.log("wakeLock error",a)}),g=J.subscribe(a=>{if(g&&g(),console.log("stearingStore upd:",a),!r){console.warn("command not sent, BLE not connected");return}console.info("sending command to BLE device");const{gear:C,dir:u,speed:B}=a,f=new TextEncoder().encode("X"+C+u+"P");f[3]=B,K.leds.setValRaw(f.buffer)});const I=()=>_();function y(){c=this.checked,t(0,c)}const h=()=>{var a;return(a=n.dataConn)==null?void 0:a.send({message:"ping!",date:new Date})};return o.$$.update=()=>{o.$$.dirty&1&&(c&&navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(a=>{D.update(C=>({...C,mediaStream:a}))}).catch(a=>{t(0,c=!1),console.log("getUserMedia error",a)}),c||D.update(a=>({...a,mediaStream:null})))},[c,r,n,l,_,I,y,h]}class Ie extends ne{constructor(e){super(),oe(this,e,ye,Pe,te,{})}}export{Ie as component,De as universal};
